/**
 * @fileoverview added by tsickle
 * Generated from: lib/bluetooth.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { __awaiter } from "tslib";
import { EventEmitter, Injectable } from '@angular/core';
import { from, fromEvent, throwError } from 'rxjs';
import { filter, map, mergeMap, takeUntil } from 'rxjs/operators';
import { ConsoleLoggerService } from './logger.service';
import { BrowserWebBluetooth } from './platform/browser';
import * as i0 from "@angular/core";
import * as i1 from "./platform/browser";
import * as i2 from "./logger.service";
export class BluetoothCore {
    /**
     * @param {?} webBle
     * @param {?} console
     */
    constructor(webBle, console) {
        this.webBle = webBle;
        this.console = console;
        this.device$ = new EventEmitter();
        this.gatt$ = new EventEmitter();
        this.characteristicValueChanges$ = new EventEmitter();
        this.gattServer = null;
    }
    /**
     * @return {?}
     */
    getDevice$() {
        return this.device$;
    }
    /**
     * @return {?}
     */
    getGATT$() {
        return this.gatt$;
    }
    /**
     * @return {?}
     */
    streamValues$() {
        return this.characteristicValueChanges$.pipe(filter((/**
         * @param {?} value
         * @return {?}
         */
        value => value && value.byteLength > 0)));
    }
    /**
     * Run the discovery process and read the value form the provided service and characteristic
     * @param {?} options the ReadValueOptions
     * @return {?}
     */
    value(options) {
        return __awaiter(this, void 0, void 0, function* () {
            this.console.log('[BLE::Info] Reading value with options %o', options);
            if (typeof options.acceptAllDevices === 'undefined') {
                options.acceptAllDevices = true;
            }
            if (typeof options.optionalServices === 'undefined') {
                options.optionalServices = [options.service];
            }
            else {
                options.optionalServices = [...options.optionalServices];
            }
            this.console.log('[BLE::Info] Reading value with options %o', options);
            try {
                /** @type {?} */
                const device = (/** @type {?} */ (yield this.discover({
                    acceptAllDevices: options.acceptAllDevices,
                    optionalServices: options.optionalServices
                })));
                this.console.log('[BLE::Info] Device info %o', device);
                /** @type {?} */
                const gatt = yield this.connectDevice(device);
                this.console.log('[BLE::Info] GATT info %o', gatt);
                /** @type {?} */
                const primaryService = (/** @type {?} */ (yield this.getPrimaryService(gatt, options.service)));
                this.console.log('[BLE::Info] Primary Service info %o', primaryService);
                /** @type {?} */
                const characteristic = (/** @type {?} */ (yield this.getCharacteristic(primaryService, options.characteristic)));
                this.console.log('[BLE::Info] Characteristic info %o', characteristic);
                /** @type {?} */
                const value = yield characteristic.readValue();
                this.console.log('[BLE::Info] Value info %o', value);
                return value;
            }
            catch (error) {
                throw new Error(error);
            }
        });
    }
    /**
     * @param {?} options
     * @return {?}
     */
    value$(options) {
        return from(this.value(options));
    }
    /**
     * Run the discovery process.
     *
     * @param {?=} options
     * @return {?} The GATT server for the chosen device
     */
    discover(options = (/** @type {?} */ ({}))) {
        return __awaiter(this, void 0, void 0, function* () {
            options.optionalServices = options.optionalServices || ['generic_access'];
            this.console.log('[BLE::Info] Requesting devices with options %o', options);
            /** @type {?} */
            let device = null;
            try {
                device = yield this.webBle.requestDevice(options);
                device.addEventListener('gattserverdisconnected', this.onDeviceDisconnected.bind(this));
                if (device) {
                    this.device$.emit(device);
                }
                else {
                    this.device$.error(`[BLE::Error] Can not get the Bluetooth Remote GATT Server. Abort.`);
                }
            }
            catch (error) {
                this.console.error(error);
            }
            return device;
        });
    }
    /**
     * This handler will trigger when the client disconnets from the server.
     *
     * @param {?} event The onDeviceDisconnected event
     * @return {?}
     */
    onDeviceDisconnected(event) {
        /** @type {?} */
        const disconnectedDevice = (/** @type {?} */ (event.target));
        this.console.log('[BLE::Info] disconnected device %o', disconnectedDevice);
        this.device$.emit(null);
    }
    /**
     * Run the discovery process.
     *
     * @param {?=} options
     * @return {?} Emites the value of the requested service read from the device
     */
    discover$(options) {
        return from(this.discover(options)).pipe(mergeMap((/**
         * @param {?} device
         * @return {?}
         */
        (device) => this.connectDevice$(device))));
    }
    /**
     * Connect to current device.
     *
     * @param {?} device
     * @return {?} Emites the gatt server instance of the requested device
     */
    connectDevice(device) {
        return __awaiter(this, void 0, void 0, function* () {
            if (device) {
                this.console.log('[BLE::Info] Connecting to Bluetooth Remote GATT Server of %o', device);
                try {
                    /** @type {?} */
                    const gattServer = yield device.gatt.connect();
                    this.gattServer = gattServer;
                    this.gatt$.emit(gattServer);
                    return gattServer;
                }
                catch (error) {
                    // probably the user has canceled the discovery
                    Promise.reject(`${error.message}`);
                    this.gatt$.error(`${error.message}`);
                }
            }
            else {
                this.console.error('[BLE::Error] Was not able to connect to Bluetooth Remote GATT Server');
                this.gatt$.error(null);
            }
        });
    }
    /**
     * Connect to current device.
     *
     * @param {?} device
     * @return {?} Emites the gatt server instance of the requested device
     */
    connectDevice$(device) {
        return from(this.connectDevice(device));
    }
    /**
     * Disconnect the current connected device
     * @return {?}
     */
    disconnectDevice() {
        if (!this.gattServer) {
            return;
        }
        this.console.log('[BLE::Info] Disconnecting from Bluetooth Device %o', this.gattServer);
        if (this.gattServer.connected) {
            this.gattServer.disconnect();
        }
        else {
            this.console.log('[BLE::Info] Bluetooth device is already disconnected');
        }
    }
    /**
     * Requests the primary service.
     *
     * @param {?} gatt The BluetoothRemoteGATTServer sever
     * @param {?} service The UUID of the primary service
     * @return {?} The remote service (as a Promise)
     */
    getPrimaryService(gatt, service) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                /** @type {?} */
                const remoteService = yield gatt.getPrimaryService(service);
                return yield Promise.resolve(remoteService);
            }
            catch (error) {
                return yield Promise.reject(`${error.message} (${service})`);
            }
        });
    }
    /**
     * Requests the primary service.
     *
     * @param {?} gatt The BluetoothRemoteGATTServer sever
     * @param {?} service The UUID of the primary service
     * @return {?} The remote service (as an observable).
     */
    getPrimaryService$(gatt, service) {
        this.console.log('[BLE::Info] Getting primary service "%s" (if available) of %o', service, gatt);
        if (gatt) {
            return from(this.getPrimaryService(gatt, service));
        }
        else {
            return throwError(new Error('[BLE::Error] Was not able to connect to the Bluetooth Remote GATT Server'));
        }
    }
    /**
     * Requests a characteristic from the primary service.
     *
     * @param {?} primaryService The primary service.
     * @param {?} characteristic The characteristic's UUID.
     * @return {?} The characteristic description (as a Promise).
     */
    getCharacteristic(primaryService, characteristic) {
        return __awaiter(this, void 0, void 0, function* () {
            this.console.log('[BLE::Info] Getting Characteristic "%s" of %o', characteristic, primaryService);
            try {
                /** @type {?} */
                const char = yield primaryService.getCharacteristic(characteristic);
                // listen for characteristic value changes
                if (char.properties.notify) {
                    char.startNotifications().then((/**
                     * @param {?} _
                     * @return {?}
                     */
                    _ => {
                        this.console.log('[BLE::Info] Starting notifications of "%s"', characteristic);
                        char.addEventListener('characteristicvaluechanged', this.onCharacteristicChanged.bind(this));
                    }), (/**
                     * @param {?} error
                     * @return {?}
                     */
                    (error) => {
                        Promise.reject(`${error.message} (${characteristic})`);
                    }));
                }
                else {
                    char.addEventListener('characteristicvaluechanged', this.onCharacteristicChanged.bind(this));
                }
                return char;
            }
            catch (rejectionError) {
                Promise.reject(`${rejectionError.message} (${characteristic})`);
            }
        });
    }
    /**
     * Requests a characteristic from the primary service.
     *
     * @param {?} primaryService The primary service.
     * @param {?} characteristic The characteristic's UUID.
     * @return {?} The characteristic description (as a Observable).
     */
    getCharacteristic$(primaryService, characteristic) {
        this.console.log('[BLE::Info] Getting Characteristic "%s" of %o', characteristic, primaryService);
        return from(this.getCharacteristic(primaryService, characteristic));
    }
    /**
     * Sets the characteristic's state.
     *
     * @param {?} service The parent service of the characteristic.
     * @param {?} characteristic The requested characteristic
     * @param {?} state An ArrayBuffer containing the value of the characteristic.
     * @return {?} The primary service (useful for chaining).
     */
    setCharacteristicState(service, characteristic, state) {
        /** @type {?} */
        const primaryService = this.getPrimaryService$(this.gattServer, service);
        primaryService
            // tslint:disable-next-line: variable-name
            .pipe(mergeMap((/**
         * @param {?} _primaryService
         * @return {?}
         */
        (_primaryService) => this.getCharacteristic$(_primaryService, characteristic))))
            // tslint:disable-next-line: no-shadowed-variable
            .subscribe((/**
         * @param {?} characteristic
         * @return {?}
         */
        (characteristic) => this.writeValue$(characteristic, state)));
        return primaryService;
    }
    /**
     * Enables the specified characteristic of a given service.
     *
     * @param {?} service The parent service of the characteristic.
     * @param {?} characteristic The requested characteristic
     * @param {?=} state
     * @return {?} The primary service (useful for chaining).
     */
    enableCharacteristic(service, characteristic, state) {
        state = state || new Uint8Array([1]);
        return this.setCharacteristicState(service, characteristic, state);
    }
    /**
     * Disables the specified characteristic of a given service.
     *
     * @param {?} service The parent service of the characteristic.
     * @param {?} characteristic The requested characteristic.
     * @param {?=} state
     * @return {?} The primary service (useful for chaining).
     */
    disbaleCharacteristic(service, characteristic, state) {
        state = state || new Uint8Array([0]);
        return this.setCharacteristicState(service, characteristic, state);
    }
    /**
     * Dispatches new values emitted by a characteristic.
     *
     * @param {?} event the distpatched event.
     * @return {?}
     */
    onCharacteristicChanged(event) {
        this.console.log('[BLE::Info] Dispatching new characteristic value %o', event);
        /** @type {?} */
        const value = ((/** @type {?} */ (event.target))).value;
        this.characteristicValueChanges$.emit(value);
    }
    /**
     * Reads a value from the characteristics, as a DataView.
     *
     * @param {?} characteristic The requested characteristic.
     * @return {?} the DataView value (as an Observable).
     */
    readValue$(characteristic) {
        this.console.log('[BLE::Info] Reading Characteristic %o', characteristic);
        return from(characteristic
            .readValue()
            .then((/**
         * @param {?} data
         * @return {?}
         */
        (data) => Promise.resolve(data)), (/**
         * @param {?} error
         * @return {?}
         */
        (error) => Promise.reject(`${error.message}`))));
    }
    /**
     * Writes a value into the specified characteristic.
     *
     * @param {?} characteristic The requested characteristic.
     * @param {?} value The value to be written (as an ArrayBuffer or Uint8Array).
     * @return {?} an void Observable.
     */
    writeValue$(characteristic, value) {
        this.console.log('[BLE::Info] Writing Characteristic %o', characteristic);
        return from(characteristic.writeValue(value).then((/**
         * @param {?} _
         * @return {?}
         */
        _ => Promise.resolve()), (/**
         * @param {?} error
         * @return {?}
         */
        (error) => Promise.reject(`${error.message}`))));
    }
    /**
     * A stream of DataView values emitted by the specified characteristic.
     *
     * @param {?} characteristic The characteristic which value you want to observe
     * @return {?} The stream of DataView values.
     */
    observeValue$(characteristic) {
        characteristic.startNotifications();
        /** @type {?} */
        const disconnected = fromEvent(characteristic.service.device, 'gattserverdisconnected');
        return fromEvent(characteristic, 'characteristicvaluechanged')
            .pipe(map((/**
         * @param {?} event
         * @return {?}
         */
        (event) => (/** @type {?} */ (((/** @type {?} */ (event.target))).value)))), takeUntil(disconnected));
    }
    /**
     * A utility method to convert LE to an unsigned 16-bit integer values.
     *
     * @param {?} data The DataView binary data.
     * @param {?} byteOffset The offset, in byte, from the start of the view where to read the data.
     * @return {?} An unsigned 16-bit integer number.
     */
    littleEndianToUint16(data, byteOffset) {
        // tslint:disable-next-line:no-bitwise
        return (this.littleEndianToUint8(data, byteOffset + 1) << 8) + this.littleEndianToUint8(data, byteOffset);
    }
    /**
     * A utility method to convert LE to an unsigned 8-bit integer values.
     *
     * @param {?} data The DataView binary data.
     * @param {?} byteOffset The offset, in byte, from the start of the view where to read the data.
     * @return {?} An unsigned 8-bit integer number.
     */
    littleEndianToUint8(data, byteOffset) {
        return data.getUint8(byteOffset);
    }
    /**
     * Sends random data (for testing purposes only).
     *
     * @param {?=} fakeValue
     * @return {?} Random unsigned 8-bit integer values.
     */
    fakeNext(fakeValue) {
        if (fakeValue === undefined) {
            fakeValue = (/**
             * @return {?}
             */
            () => {
                /** @type {?} */
                const dv = new DataView(new ArrayBuffer(8));
                // tslint:disable-next-line:no-bitwise
                dv.setUint8(0, (Math.random() * 110) | 0);
                return dv;
            });
        }
        this.characteristicValueChanges$.emit(fakeValue());
    }
}
BluetoothCore.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
BluetoothCore.ctorParameters = () => [
    { type: BrowserWebBluetooth },
    { type: ConsoleLoggerService }
];
/** @nocollapse */ BluetoothCore.ɵprov = i0.ɵɵdefineInjectable({ factory: function BluetoothCore_Factory() { return new BluetoothCore(i0.ɵɵinject(i1.BrowserWebBluetooth), i0.ɵɵinject(i2.ConsoleLoggerService)); }, token: BluetoothCore, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    BluetoothCore.prototype.device$;
    /**
     * @type {?}
     * @private
     */
    BluetoothCore.prototype.gatt$;
    /**
     * @type {?}
     * @private
     */
    BluetoothCore.prototype.characteristicValueChanges$;
    /**
     * @type {?}
     * @private
     */
    BluetoothCore.prototype.gattServer;
    /**
     * @type {?}
     * @private
     */
    BluetoothCore.prototype.webBle;
    /**
     * @type {?}
     * @private
     */
    BluetoothCore.prototype.console;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmx1ZXRvb3RoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbWFuZWtpbmVra28vYW5ndWxhci13ZWItYmx1ZXRvb3RoLyIsInNvdXJjZXMiOlsibGliL2JsdWV0b290aC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvRCxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7Ozs7QUFZekQsTUFBTSxPQUFPLGFBQWE7Ozs7O0lBTXhCLFlBQTZCLE1BQTJCLEVBQW1CLE9BQTZCO1FBQTNFLFdBQU0sR0FBTixNQUFNLENBQXFCO1FBQW1CLFlBQU8sR0FBUCxPQUFPLENBQXNCO1FBRXRHLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxZQUFZLEVBQW1CLENBQUM7UUFDbkQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLFlBQVksRUFBNkIsQ0FBQztRQUMzRCxJQUFJLENBQUMsMkJBQTJCLEdBQUcsSUFBSSxZQUFZLEVBQVksQ0FBQztRQUVoRSxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztJQUN6QixDQUFDOzs7O0lBRUQsVUFBVTtRQUNSLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN0QixDQUFDOzs7O0lBRUQsUUFBUTtRQUNOLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDOzs7O0lBRUQsYUFBYTtRQUNYLE9BQU8sSUFBSSxDQUFDLDJCQUEyQixDQUFDLElBQUks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QUMsSUFBSSxFQUFFLFVBQVUsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQzVHLENBQUM7Ozs7Ozs7O0lBU0QsbUJBQW1CLENBQUMsSUFBUyxFQUFFLFVBQWtCO1FBQy9DLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNuQyxDQUFDOzs7Ozs7O0lBT0QsUUFBUSxDQUFDLFNBQTBCO1FBQ2pDLElBQUksU0FBUyxLQUFLLFNBQVMsRUFBRTtZQUMzQixTQUFTOzs7WUFBRyxHQUFHLEVBQUU7O3NCQUNULEVBQUUsR0FBRyxJQUFJLFFBQVEsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDM0Msc0NBQXNDO2dCQUN0QyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDMUMsT0FBTyxFQUFFLENBQUM7WUFDWixDQUFDLENBQUEsQ0FBQztTQUNIO1FBRUQsSUFBSSxDQUFDLDJCQUEyQixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQ3JELENBQUM7OztZQTFaRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7Ozs7WUFYUSxtQkFBbUI7WUFEbkIsb0JBQW9COzs7Ozs7OztJQWMzQixnQ0FBK0M7Ozs7O0lBQy9DLDhCQUF1RDs7Ozs7SUFDdkQsb0RBQTREOzs7OztJQUM1RCxtQ0FBOEM7Ozs7O0lBRWxDLCtCQUE0Qzs7Ozs7SUFBRSxnQ0FBOEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZyb20sIGZyb21FdmVudCwgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIG1lcmdlTWFwLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDb25zb2xlTG9nZ2VyU2VydmljZSB9IGZyb20gJy4vbG9nZ2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgQnJvd3NlcldlYkJsdWV0b290aCB9IGZyb20gJy4vcGxhdGZvcm0vYnJvd3Nlcic7XG5cbnR5cGUgUmVhZFZhbHVlT3B0aW9ucyA9IHtcbiAgYWNjZXB0QWxsRGV2aWNlcz86IGJvb2xlYW47XG4gIG9wdGlvbmFsU2VydmljZXM/OiBCbHVldG9vdGhTZXJ2aWNlVVVJRFtdO1xuICBjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoQ2hhcmFjdGVyaXN0aWNVVUlELFxuICBzZXJ2aWNlOiBCbHVldG9vdGhTZXJ2aWNlVVVJRCxcbn07XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEJsdWV0b290aENvcmUge1xuICBwcml2YXRlIGRldmljZSQ6IEV2ZW50RW1pdHRlcjxCbHVldG9vdGhEZXZpY2U+O1xuICBwcml2YXRlIGdhdHQkOiBFdmVudEVtaXR0ZXI8Qmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZlcj47XG4gIHByaXZhdGUgY2hhcmFjdGVyaXN0aWNWYWx1ZUNoYW5nZXMkOiBFdmVudEVtaXR0ZXI8RGF0YVZpZXc+O1xuICBwcml2YXRlIGdhdHRTZXJ2ZXI6IEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2ZXI7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSB3ZWJCbGU6IEJyb3dzZXJXZWJCbHVldG9vdGgsIHByaXZhdGUgcmVhZG9ubHkgY29uc29sZTogQ29uc29sZUxvZ2dlclNlcnZpY2UpIHtcblxuICAgIHRoaXMuZGV2aWNlJCA9IG5ldyBFdmVudEVtaXR0ZXI8Qmx1ZXRvb3RoRGV2aWNlPigpO1xuICAgIHRoaXMuZ2F0dCQgPSBuZXcgRXZlbnRFbWl0dGVyPEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2ZXI+KCk7XG4gICAgdGhpcy5jaGFyYWN0ZXJpc3RpY1ZhbHVlQ2hhbmdlcyQgPSBuZXcgRXZlbnRFbWl0dGVyPERhdGFWaWV3PigpO1xuXG4gICAgdGhpcy5nYXR0U2VydmVyID0gbnVsbDtcbiAgfVxuXG4gIGdldERldmljZSQoKTogT2JzZXJ2YWJsZTxCbHVldG9vdGhEZXZpY2U+IHtcbiAgICByZXR1cm4gdGhpcy5kZXZpY2UkO1xuICB9XG5cbiAgZ2V0R0FUVCQoKTogT2JzZXJ2YWJsZTxCbHVldG9vdGhSZW1vdGVHQVRUU2VydmVyPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2F0dCQ7XG4gIH1cblxuICBzdHJlYW1WYWx1ZXMkKCk6IE9ic2VydmFibGU8RGF0YVZpZXc+IHtcbiAgICByZXR1cm4gdGhpcy5jaGFyYWN0ZXJpc3RpY1ZhbHVlQ2hhbmdlcyQucGlwZShmaWx0ZXIodmFsdWUgPT4gdmFsdWUgJiYgdmFsdWUuYnl0ZUxlbmd0aCA+IDApKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gdGhlIGRpc2NvdmVyeSBwcm9jZXNzIGFuZCByZWFkIHRoZSB2YWx1ZSBmb3JtIHRoZSBwcm92aWRlZCBzZXJ2aWNlIGFuZCBjaGFyYWN0ZXJpc3RpY1xuICAgKiBAcGFyYW0gb3B0aW9ucyB0aGUgUmVhZFZhbHVlT3B0aW9uc1xuICAgKi9cbiAgYXN5bmMgdmFsdWUob3B0aW9uczogUmVhZFZhbHVlT3B0aW9ucykge1xuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIFJlYWRpbmcgdmFsdWUgd2l0aCBvcHRpb25zICVvJywgb3B0aW9ucyk7XG5cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMuYWNjZXB0QWxsRGV2aWNlcyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIG9wdGlvbnMuYWNjZXB0QWxsRGV2aWNlcyA9IHRydWU7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLm9wdGlvbmFsU2VydmljZXMgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBvcHRpb25zLm9wdGlvbmFsU2VydmljZXMgPSBbb3B0aW9ucy5zZXJ2aWNlXTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBvcHRpb25zLm9wdGlvbmFsU2VydmljZXMgPSBbLi4ub3B0aW9ucy5vcHRpb25hbFNlcnZpY2VzXTtcbiAgICB9XG5cbiAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBSZWFkaW5nIHZhbHVlIHdpdGggb3B0aW9ucyAlbycsIG9wdGlvbnMpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRldmljZSA9IGF3YWl0IHRoaXMuZGlzY292ZXIoe1xuICAgICAgICBhY2NlcHRBbGxEZXZpY2VzOiBvcHRpb25zLmFjY2VwdEFsbERldmljZXMsXG4gICAgICAgIG9wdGlvbmFsU2VydmljZXM6IG9wdGlvbnMub3B0aW9uYWxTZXJ2aWNlc1xuICAgICAgfSkgYXMgQmx1ZXRvb3RoRGV2aWNlO1xuICAgICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gRGV2aWNlIGluZm8gJW8nLCBkZXZpY2UpO1xuXG4gICAgICBjb25zdCBnYXR0ID0gYXdhaXQgdGhpcy5jb25uZWN0RGV2aWNlKGRldmljZSk7XG4gICAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBHQVRUIGluZm8gJW8nLCBnYXR0KTtcblxuICAgICAgY29uc3QgcHJpbWFyeVNlcnZpY2UgPSBhd2FpdCB0aGlzLmdldFByaW1hcnlTZXJ2aWNlKGdhdHQsIG9wdGlvbnMuc2VydmljZSkgYXMgQmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZpY2U7XG4gICAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBQcmltYXJ5IFNlcnZpY2UgaW5mbyAlbycsIHByaW1hcnlTZXJ2aWNlKTtcblxuICAgICAgY29uc3QgY2hhcmFjdGVyaXN0aWMgPSBhd2FpdCB0aGlzLmdldENoYXJhY3RlcmlzdGljKHByaW1hcnlTZXJ2aWNlLCBvcHRpb25zLmNoYXJhY3RlcmlzdGljKSBhcyBCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWM7XG4gICAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBDaGFyYWN0ZXJpc3RpYyBpbmZvICVvJywgY2hhcmFjdGVyaXN0aWMpO1xuXG4gICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IGNoYXJhY3RlcmlzdGljLnJlYWRWYWx1ZSgpO1xuICAgICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gVmFsdWUgaW5mbyAlbycsIHZhbHVlKTtcblxuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgdmFsdWUkKG9wdGlvbnM6IFJlYWRWYWx1ZU9wdGlvbnMpIHtcbiAgICByZXR1cm4gZnJvbSh0aGlzLnZhbHVlKG9wdGlvbnMpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gdGhlIGRpc2NvdmVyeSBwcm9jZXNzLlxuICAgKlxuICAgKiBAcGFyYW0gT3B0aW9ucyBzdWNoIGFzIGZpbHRlcnMgYW5kIG9wdGlvbmFsIHNlcnZpY2VzXG4gICAqIEByZXR1cm4gIFRoZSBHQVRUIHNlcnZlciBmb3IgdGhlIGNob3NlbiBkZXZpY2VcbiAgICovXG4gIGFzeW5jIGRpc2NvdmVyKG9wdGlvbnM6IFJlcXVlc3REZXZpY2VPcHRpb25zID0ge30gYXMgUmVxdWVzdERldmljZU9wdGlvbnMpIHtcbiAgICBvcHRpb25zLm9wdGlvbmFsU2VydmljZXMgPSBvcHRpb25zLm9wdGlvbmFsU2VydmljZXMgfHwgWydnZW5lcmljX2FjY2VzcyddO1xuXG4gICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gUmVxdWVzdGluZyBkZXZpY2VzIHdpdGggb3B0aW9ucyAlbycsIG9wdGlvbnMpO1xuXG4gICAgbGV0IGRldmljZSA9IG51bGw7XG4gICAgdHJ5IHtcbiAgICAgIGRldmljZSA9IGF3YWl0IHRoaXMud2ViQmxlLnJlcXVlc3REZXZpY2Uob3B0aW9ucyk7XG4gICAgICBkZXZpY2UuYWRkRXZlbnRMaXN0ZW5lcignZ2F0dHNlcnZlcmRpc2Nvbm5lY3RlZCcsIHRoaXMub25EZXZpY2VEaXNjb25uZWN0ZWQuYmluZCh0aGlzKSk7XG5cbiAgICAgIGlmIChkZXZpY2UpIHtcbiAgICAgICAgdGhpcy5kZXZpY2UkLmVtaXQoZGV2aWNlKTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aGlzLmRldmljZSQuZXJyb3IoYFtCTEU6OkVycm9yXSBDYW4gbm90IGdldCB0aGUgQmx1ZXRvb3RoIFJlbW90ZSBHQVRUIFNlcnZlci4gQWJvcnQuYCk7XG4gICAgICB9XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5jb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGV2aWNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgaGFuZGxlciB3aWxsIHRyaWdnZXIgd2hlbiB0aGUgY2xpZW50IGRpc2Nvbm5ldHMgZnJvbSB0aGUgc2VydmVyLlxuICAgKlxuICAgKiBAcGFyYW0gZXZlbnQgVGhlIG9uRGV2aWNlRGlzY29ubmVjdGVkIGV2ZW50XG4gICAqL1xuICBvbkRldmljZURpc2Nvbm5lY3RlZChldmVudDogRXZlbnQpIHtcbiAgICBjb25zdCBkaXNjb25uZWN0ZWREZXZpY2UgPSBldmVudC50YXJnZXQgYXMgQmx1ZXRvb3RoRGV2aWNlO1xuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIGRpc2Nvbm5lY3RlZCBkZXZpY2UgJW8nLCBkaXNjb25uZWN0ZWREZXZpY2UpO1xuXG4gICAgdGhpcy5kZXZpY2UkLmVtaXQobnVsbCk7XG4gIH1cblxuICAvKipcbiAgICogUnVuIHRoZSBkaXNjb3ZlcnkgcHJvY2Vzcy5cbiAgICpcbiAgICogQHBhcmFtIE9wdGlvbnMgc3VjaCBhcyBmaWx0ZXJzIGFuZCBvcHRpb25hbCBzZXJ2aWNlc1xuICAgKiBAcmV0dXJuICBFbWl0ZXMgdGhlIHZhbHVlIG9mIHRoZSByZXF1ZXN0ZWQgc2VydmljZSByZWFkIGZyb20gdGhlIGRldmljZVxuICAgKi9cbiAgZGlzY292ZXIkKG9wdGlvbnM/OiBSZXF1ZXN0RGV2aWNlT3B0aW9ucyk6IE9ic2VydmFibGU8dm9pZCB8IEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2ZXI+IHtcbiAgICByZXR1cm4gZnJvbSh0aGlzLmRpc2NvdmVyKG9wdGlvbnMpKS5waXBlKG1lcmdlTWFwKChkZXZpY2U6IEJsdWV0b290aERldmljZSkgPT4gdGhpcy5jb25uZWN0RGV2aWNlJChkZXZpY2UpKSk7XG4gIH1cblxuICAvKipcbiAgICogQ29ubmVjdCB0byBjdXJyZW50IGRldmljZS5cbiAgICpcbiAgICogQHJldHVybiAgRW1pdGVzIHRoZSBnYXR0IHNlcnZlciBpbnN0YW5jZSBvZiB0aGUgcmVxdWVzdGVkIGRldmljZVxuICAgKi9cbiAgYXN5bmMgY29ubmVjdERldmljZShkZXZpY2U6IEJsdWV0b290aERldmljZSkge1xuICAgIGlmIChkZXZpY2UpIHtcbiAgICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIENvbm5lY3RpbmcgdG8gQmx1ZXRvb3RoIFJlbW90ZSBHQVRUIFNlcnZlciBvZiAlbycsIGRldmljZSk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGdhdHRTZXJ2ZXIgPSBhd2FpdCBkZXZpY2UuZ2F0dC5jb25uZWN0KCk7XG4gICAgICAgIHRoaXMuZ2F0dFNlcnZlciA9IGdhdHRTZXJ2ZXI7XG4gICAgICAgIHRoaXMuZ2F0dCQuZW1pdChnYXR0U2VydmVyKTtcbiAgICAgICAgcmV0dXJuIGdhdHRTZXJ2ZXI7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAvLyBwcm9iYWJseSB0aGUgdXNlciBoYXMgY2FuY2VsZWQgdGhlIGRpc2NvdmVyeVxuICAgICAgICBQcm9taXNlLnJlamVjdChgJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgICB0aGlzLmdhdHQkLmVycm9yKGAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY29uc29sZS5lcnJvcignW0JMRTo6RXJyb3JdIFdhcyBub3QgYWJsZSB0byBjb25uZWN0IHRvIEJsdWV0b290aCBSZW1vdGUgR0FUVCBTZXJ2ZXInKTtcbiAgICAgIHRoaXMuZ2F0dCQuZXJyb3IobnVsbCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENvbm5lY3QgdG8gY3VycmVudCBkZXZpY2UuXG4gICAqXG4gICAqIEByZXR1cm4gIEVtaXRlcyB0aGUgZ2F0dCBzZXJ2ZXIgaW5zdGFuY2Ugb2YgdGhlIHJlcXVlc3RlZCBkZXZpY2VcbiAgICovXG4gIGNvbm5lY3REZXZpY2UkKGRldmljZTogQmx1ZXRvb3RoRGV2aWNlKSB7XG4gICAgcmV0dXJuIGZyb20odGhpcy5jb25uZWN0RGV2aWNlKGRldmljZSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIERpc2Nvbm5lY3QgdGhlIGN1cnJlbnQgY29ubmVjdGVkIGRldmljZVxuICAgKi9cbiAgZGlzY29ubmVjdERldmljZSgpIHtcbiAgICBpZiAoIXRoaXMuZ2F0dFNlcnZlcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBEaXNjb25uZWN0aW5nIGZyb20gQmx1ZXRvb3RoIERldmljZSAlbycsIHRoaXMuZ2F0dFNlcnZlcik7XG5cbiAgICBpZiAodGhpcy5nYXR0U2VydmVyLmNvbm5lY3RlZCkge1xuICAgICAgdGhpcy5nYXR0U2VydmVyLmRpc2Nvbm5lY3QoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gQmx1ZXRvb3RoIGRldmljZSBpcyBhbHJlYWR5IGRpc2Nvbm5lY3RlZCcpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXF1ZXN0cyB0aGUgcHJpbWFyeSBzZXJ2aWNlLlxuICAgKlxuICAgKiBAcGFyYW0gZ2F0dCBUaGUgQmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZlciBzZXZlclxuICAgKiBAcGFyYW0gc2VydmljZSBUaGUgVVVJRCBvZiB0aGUgcHJpbWFyeSBzZXJ2aWNlXG4gICAqIEByZXR1cm4gVGhlIHJlbW90ZSBzZXJ2aWNlIChhcyBhIFByb21pc2UpXG4gICAqL1xuICBhc3luYyBnZXRQcmltYXJ5U2VydmljZShnYXR0OiBCbHVldG9vdGhSZW1vdGVHQVRUU2VydmVyLCBzZXJ2aWNlOiBCbHVldG9vdGhTZXJ2aWNlVVVJRCk6IFByb21pc2U8Qmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZpY2U+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVtb3RlU2VydmljZSA9IGF3YWl0IGdhdHQuZ2V0UHJpbWFyeVNlcnZpY2Uoc2VydmljZSk7XG4gICAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5yZXNvbHZlKHJlbW90ZVNlcnZpY2UpO1xuICAgIH1cbiAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBhd2FpdCBQcm9taXNlLnJlamVjdChgJHtlcnJvci5tZXNzYWdlfSAoJHtzZXJ2aWNlfSlgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVxdWVzdHMgdGhlIHByaW1hcnkgc2VydmljZS5cbiAgICpcbiAgICogQHBhcmFtIGdhdHQgVGhlIEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2ZXIgc2V2ZXJcbiAgICogQHBhcmFtIHNlcnZpY2UgVGhlIFVVSUQgb2YgdGhlIHByaW1hcnkgc2VydmljZVxuICAgKiBAcmV0dXJuIFRoZSByZW1vdGUgc2VydmljZSAoYXMgYW4gb2JzZXJ2YWJsZSkuXG4gICAqL1xuICBnZXRQcmltYXJ5U2VydmljZSQoZ2F0dDogQmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZlciwgc2VydmljZTogQmx1ZXRvb3RoU2VydmljZVVVSUQpOiBPYnNlcnZhYmxlPEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2aWNlPiB7XG4gICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gR2V0dGluZyBwcmltYXJ5IHNlcnZpY2UgXCIlc1wiIChpZiBhdmFpbGFibGUpIG9mICVvJywgc2VydmljZSwgZ2F0dCk7XG5cblxuICAgIGlmIChnYXR0KSB7XG4gICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgdGhpcy5nZXRQcmltYXJ5U2VydmljZShnYXR0LCBzZXJ2aWNlKVxuICAgICAgKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICByZXR1cm4gdGhyb3dFcnJvcihuZXcgRXJyb3IoJ1tCTEU6OkVycm9yXSBXYXMgbm90IGFibGUgdG8gY29ubmVjdCB0byB0aGUgQmx1ZXRvb3RoIFJlbW90ZSBHQVRUIFNlcnZlcicpKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVxdWVzdHMgYSBjaGFyYWN0ZXJpc3RpYyBmcm9tIHRoZSBwcmltYXJ5IHNlcnZpY2UuXG4gICAqXG4gICAqIEBwYXJhbSBwcmltYXJ5U2VydmljZSBUaGUgcHJpbWFyeSBzZXJ2aWNlLlxuICAgKiBAcGFyYW0gY2hhcmFjdGVyaXN0aWMgVGhlIGNoYXJhY3RlcmlzdGljJ3MgVVVJRC5cbiAgICogQHJldHVybnMgVGhlIGNoYXJhY3RlcmlzdGljIGRlc2NyaXB0aW9uIChhcyBhIFByb21pc2UpLlxuICAgKi9cbiAgYXN5bmMgZ2V0Q2hhcmFjdGVyaXN0aWMoXG4gICAgcHJpbWFyeVNlcnZpY2U6IEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2aWNlLFxuICAgIGNoYXJhY3RlcmlzdGljOiBCbHVldG9vdGhDaGFyYWN0ZXJpc3RpY1VVSURcbiAgKTogUHJvbWlzZTxCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWMgfCB2b2lkPiB7XG4gICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gR2V0dGluZyBDaGFyYWN0ZXJpc3RpYyBcIiVzXCIgb2YgJW8nLCBjaGFyYWN0ZXJpc3RpYywgcHJpbWFyeVNlcnZpY2UpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNoYXIgPSBhd2FpdCBwcmltYXJ5U2VydmljZS5nZXRDaGFyYWN0ZXJpc3RpYyhjaGFyYWN0ZXJpc3RpYyk7XG4gICAgICAvLyBsaXN0ZW4gZm9yIGNoYXJhY3RlcmlzdGljIHZhbHVlIGNoYW5nZXNcbiAgICAgIGlmIChjaGFyLnByb3BlcnRpZXMubm90aWZ5KSB7XG4gICAgICAgIGNoYXIuc3RhcnROb3RpZmljYXRpb25zKCkudGhlbihfID0+IHtcbiAgICAgICAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBTdGFydGluZyBub3RpZmljYXRpb25zIG9mIFwiJXNcIicsIGNoYXJhY3RlcmlzdGljKTtcbiAgICAgICAgICBjaGFyLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYXJhY3RlcmlzdGljdmFsdWVjaGFuZ2VkJywgdGhpcy5vbkNoYXJhY3RlcmlzdGljQ2hhbmdlZC5iaW5kKHRoaXMpKTtcbiAgICAgICAgfSwgKGVycm9yOiBET01FeGNlcHRpb24pID0+IHtcbiAgICAgICAgICBQcm9taXNlLnJlamVjdChgJHtlcnJvci5tZXNzYWdlfSAoJHtjaGFyYWN0ZXJpc3RpY30pYCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIGNoYXIuYWRkRXZlbnRMaXN0ZW5lcignY2hhcmFjdGVyaXN0aWN2YWx1ZWNoYW5nZWQnLCB0aGlzLm9uQ2hhcmFjdGVyaXN0aWNDaGFuZ2VkLmJpbmQodGhpcykpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGNoYXI7XG4gICAgfVxuICAgIGNhdGNoIChyZWplY3Rpb25FcnJvcikge1xuICAgICAgUHJvbWlzZS5yZWplY3QoYCR7cmVqZWN0aW9uRXJyb3IubWVzc2FnZX0gKCR7Y2hhcmFjdGVyaXN0aWN9KWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXF1ZXN0cyBhIGNoYXJhY3RlcmlzdGljIGZyb20gdGhlIHByaW1hcnkgc2VydmljZS5cbiAgICpcbiAgICogQHBhcmFtIHByaW1hcnlTZXJ2aWNlIFRoZSBwcmltYXJ5IHNlcnZpY2UuXG4gICAqIEBwYXJhbSBjaGFyYWN0ZXJpc3RpYyBUaGUgY2hhcmFjdGVyaXN0aWMncyBVVUlELlxuICAgKiBAcmV0dXJucyBUaGUgY2hhcmFjdGVyaXN0aWMgZGVzY3JpcHRpb24gKGFzIGEgT2JzZXJ2YWJsZSkuXG4gICAqL1xuICBnZXRDaGFyYWN0ZXJpc3RpYyQoXG4gICAgcHJpbWFyeVNlcnZpY2U6IEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2aWNlLFxuICAgIGNoYXJhY3RlcmlzdGljOiBCbHVldG9vdGhDaGFyYWN0ZXJpc3RpY1VVSURcbiAgKTogT2JzZXJ2YWJsZTx2b2lkIHwgQmx1ZXRvb3RoUmVtb3RlR0FUVENoYXJhY3RlcmlzdGljPiB7XG4gICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gR2V0dGluZyBDaGFyYWN0ZXJpc3RpYyBcIiVzXCIgb2YgJW8nLCBjaGFyYWN0ZXJpc3RpYywgcHJpbWFyeVNlcnZpY2UpO1xuXG4gICAgcmV0dXJuIGZyb20odGhpcy5nZXRDaGFyYWN0ZXJpc3RpYyhwcmltYXJ5U2VydmljZSwgY2hhcmFjdGVyaXN0aWMpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBjaGFyYWN0ZXJpc3RpYydzIHN0YXRlLlxuICAgKlxuICAgKiBAcGFyYW0gc2VydmljZSBUaGUgcGFyZW50IHNlcnZpY2Ugb2YgdGhlIGNoYXJhY3RlcmlzdGljLlxuICAgKiBAcGFyYW0gY2hhcmFjdGVyaXN0aWMgVGhlIHJlcXVlc3RlZCBjaGFyYWN0ZXJpc3RpY1xuICAgKiBAcGFyYW0gc3RhdGUgQW4gQXJyYXlCdWZmZXIgY29udGFpbmluZyB0aGUgdmFsdWUgb2YgdGhlIGNoYXJhY3RlcmlzdGljLlxuICAgKiBAcmV0dXJuIFRoZSBwcmltYXJ5IHNlcnZpY2UgKHVzZWZ1bCBmb3IgY2hhaW5pbmcpLlxuICAgKi9cbiAgc2V0Q2hhcmFjdGVyaXN0aWNTdGF0ZShzZXJ2aWNlOiBCbHVldG9vdGhTZXJ2aWNlVVVJRCwgY2hhcmFjdGVyaXN0aWM6IEJsdWV0b290aENoYXJhY3RlcmlzdGljVVVJRCwgc3RhdGU6IEFycmF5QnVmZmVyKSB7XG4gICAgY29uc3QgcHJpbWFyeVNlcnZpY2UgPSB0aGlzLmdldFByaW1hcnlTZXJ2aWNlJCh0aGlzLmdhdHRTZXJ2ZXIsIHNlcnZpY2UpO1xuXG4gICAgcHJpbWFyeVNlcnZpY2VcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogdmFyaWFibGUtbmFtZVxuICAgICAgLnBpcGUobWVyZ2VNYXAoKF9wcmltYXJ5U2VydmljZTogQmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZpY2UpID0+IHRoaXMuZ2V0Q2hhcmFjdGVyaXN0aWMkKF9wcmltYXJ5U2VydmljZSwgY2hhcmFjdGVyaXN0aWMpKSlcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tc2hhZG93ZWQtdmFyaWFibGVcbiAgICAgIC5zdWJzY3JpYmUoKGNoYXJhY3RlcmlzdGljOiBCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWMpID0+IHRoaXMud3JpdGVWYWx1ZSQoY2hhcmFjdGVyaXN0aWMsIHN0YXRlKSk7XG5cbiAgICByZXR1cm4gcHJpbWFyeVNlcnZpY2U7XG4gIH1cblxuICAvKipcbiAgICogRW5hYmxlcyB0aGUgc3BlY2lmaWVkIGNoYXJhY3RlcmlzdGljIG9mIGEgZ2l2ZW4gc2VydmljZS5cbiAgICpcbiAgICogQHBhcmFtIHNlcnZpY2UgVGhlIHBhcmVudCBzZXJ2aWNlIG9mIHRoZSBjaGFyYWN0ZXJpc3RpYy5cbiAgICogQHBhcmFtIGNoYXJhY3RlcmlzdGljIFRoZSByZXF1ZXN0ZWQgY2hhcmFjdGVyaXN0aWNcbiAgICogQHJldHVybiBUaGUgcHJpbWFyeSBzZXJ2aWNlICh1c2VmdWwgZm9yIGNoYWluaW5nKS5cbiAgICovXG4gIGVuYWJsZUNoYXJhY3RlcmlzdGljKHNlcnZpY2U6IEJsdWV0b290aFNlcnZpY2VVVUlELCBjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoQ2hhcmFjdGVyaXN0aWNVVUlELCBzdGF0ZT86IGFueSkge1xuICAgIHN0YXRlID0gc3RhdGUgfHwgbmV3IFVpbnQ4QXJyYXkoWzFdKTtcbiAgICByZXR1cm4gdGhpcy5zZXRDaGFyYWN0ZXJpc3RpY1N0YXRlKHNlcnZpY2UsIGNoYXJhY3RlcmlzdGljLCBzdGF0ZSk7XG4gIH1cblxuICAvKipcbiAgICogRGlzYWJsZXMgdGhlIHNwZWNpZmllZCBjaGFyYWN0ZXJpc3RpYyBvZiBhIGdpdmVuIHNlcnZpY2UuXG4gICAqXG4gICAqIEBwYXJhbSBzZXJ2aWNlIFRoZSBwYXJlbnQgc2VydmljZSBvZiB0aGUgY2hhcmFjdGVyaXN0aWMuXG4gICAqIEBwYXJhbSBjaGFyYWN0ZXJpc3RpYyBUaGUgcmVxdWVzdGVkIGNoYXJhY3RlcmlzdGljLlxuICAgKiBAcmV0dXJuIFRoZSBwcmltYXJ5IHNlcnZpY2UgKHVzZWZ1bCBmb3IgY2hhaW5pbmcpLlxuICAgKi9cbiAgZGlzYmFsZUNoYXJhY3RlcmlzdGljKHNlcnZpY2U6IEJsdWV0b290aFNlcnZpY2VVVUlELCBjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoQ2hhcmFjdGVyaXN0aWNVVUlELCBzdGF0ZT86IGFueSkge1xuICAgIHN0YXRlID0gc3RhdGUgfHwgbmV3IFVpbnQ4QXJyYXkoWzBdKTtcbiAgICByZXR1cm4gdGhpcy5zZXRDaGFyYWN0ZXJpc3RpY1N0YXRlKHNlcnZpY2UsIGNoYXJhY3RlcmlzdGljLCBzdGF0ZSk7XG4gIH1cblxuICAvKipcbiAgICogRGlzcGF0Y2hlcyBuZXcgdmFsdWVzIGVtaXR0ZWQgYnkgYSBjaGFyYWN0ZXJpc3RpYy5cbiAgICpcbiAgICogQHBhcmFtIGV2ZW50IHRoZSBkaXN0cGF0Y2hlZCBldmVudC5cbiAgICovXG4gIG9uQ2hhcmFjdGVyaXN0aWNDaGFuZ2VkKGV2ZW50OiBFdmVudCkge1xuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIERpc3BhdGNoaW5nIG5ldyBjaGFyYWN0ZXJpc3RpYyB2YWx1ZSAlbycsIGV2ZW50KTtcblxuICAgIGNvbnN0IHZhbHVlID0gKGV2ZW50LnRhcmdldCBhcyBCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWMpLnZhbHVlO1xuICAgIHRoaXMuY2hhcmFjdGVyaXN0aWNWYWx1ZUNoYW5nZXMkLmVtaXQodmFsdWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlYWRzIGEgdmFsdWUgZnJvbSB0aGUgY2hhcmFjdGVyaXN0aWNzLCBhcyBhIERhdGFWaWV3LlxuICAgKlxuICAgKiBAcGFyYW0gY2hhcmFjdGVyaXN0aWMgVGhlIHJlcXVlc3RlZCBjaGFyYWN0ZXJpc3RpYy5cbiAgICogQHJldHVybiB0aGUgRGF0YVZpZXcgdmFsdWUgKGFzIGFuIE9ic2VydmFibGUpLlxuICAgKi9cbiAgcmVhZFZhbHVlJChjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoUmVtb3RlR0FUVENoYXJhY3RlcmlzdGljKTogT2JzZXJ2YWJsZTxEYXRhVmlldz4ge1xuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIFJlYWRpbmcgQ2hhcmFjdGVyaXN0aWMgJW8nLCBjaGFyYWN0ZXJpc3RpYyk7XG5cbiAgICByZXR1cm4gZnJvbShcbiAgICAgIGNoYXJhY3RlcmlzdGljXG4gICAgICAgIC5yZWFkVmFsdWUoKVxuICAgICAgICAudGhlbigoZGF0YTogRGF0YVZpZXcpID0+IFByb21pc2UucmVzb2x2ZShkYXRhKSwgKGVycm9yOiBET01FeGNlcHRpb24pID0+IFByb21pc2UucmVqZWN0KGAke2Vycm9yLm1lc3NhZ2V9YCkpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXcml0ZXMgYSB2YWx1ZSBpbnRvIHRoZSBzcGVjaWZpZWQgY2hhcmFjdGVyaXN0aWMuXG4gICAqXG4gICAqIEBwYXJhbSBjaGFyYWN0ZXJpc3RpYyBUaGUgcmVxdWVzdGVkIGNoYXJhY3RlcmlzdGljLlxuICAgKiBAcGFyYW0gdmFsdWUgVGhlIHZhbHVlIHRvIGJlIHdyaXR0ZW4gKGFzIGFuIEFycmF5QnVmZmVyIG9yIFVpbnQ4QXJyYXkpLlxuICAgKiBAcmV0dXJuIGFuIHZvaWQgT2JzZXJ2YWJsZS5cbiAgICovXG4gIHdyaXRlVmFsdWUkKGNoYXJhY3RlcmlzdGljOiBCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWMsIHZhbHVlOiBBcnJheUJ1ZmZlciB8IFVpbnQ4QXJyYXkpIHtcbiAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBXcml0aW5nIENoYXJhY3RlcmlzdGljICVvJywgY2hhcmFjdGVyaXN0aWMpO1xuXG4gICAgcmV0dXJuIGZyb20oY2hhcmFjdGVyaXN0aWMud3JpdGVWYWx1ZSh2YWx1ZSkudGhlbihfID0+IFByb21pc2UucmVzb2x2ZSgpLCAoZXJyb3I6IERPTUV4Y2VwdGlvbikgPT4gUHJvbWlzZS5yZWplY3QoYCR7ZXJyb3IubWVzc2FnZX1gKSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgc3RyZWFtIG9mIERhdGFWaWV3IHZhbHVlcyBlbWl0dGVkIGJ5IHRoZSBzcGVjaWZpZWQgY2hhcmFjdGVyaXN0aWMuXG4gICAqXG4gICAqIEBwYXJhbSBjaGFyYWN0ZXJpc3RpYyBUaGUgY2hhcmFjdGVyaXN0aWMgd2hpY2ggdmFsdWUgeW91IHdhbnQgdG8gb2JzZXJ2ZVxuICAgKiBAcmV0dXJuIFRoZSBzdHJlYW0gb2YgRGF0YVZpZXcgdmFsdWVzLlxuICAgKi9cbiAgb2JzZXJ2ZVZhbHVlJChjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoUmVtb3RlR0FUVENoYXJhY3RlcmlzdGljKTogT2JzZXJ2YWJsZTxEYXRhVmlldz4ge1xuICAgIGNoYXJhY3RlcmlzdGljLnN0YXJ0Tm90aWZpY2F0aW9ucygpO1xuICAgIGNvbnN0IGRpc2Nvbm5lY3RlZCA9IGZyb21FdmVudChjaGFyYWN0ZXJpc3RpYy5zZXJ2aWNlLmRldmljZSwgJ2dhdHRzZXJ2ZXJkaXNjb25uZWN0ZWQnKTtcbiAgICByZXR1cm4gZnJvbUV2ZW50KGNoYXJhY3RlcmlzdGljLCAnY2hhcmFjdGVyaXN0aWN2YWx1ZWNoYW5nZWQnKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoZXZlbnQ6IEV2ZW50KSA9PiAoZXZlbnQudGFyZ2V0IGFzIEJsdWV0b290aFJlbW90ZUdBVFRDaGFyYWN0ZXJpc3RpYykudmFsdWUgYXMgRGF0YVZpZXcpLFxuICAgICAgICB0YWtlVW50aWwoZGlzY29ubmVjdGVkKVxuICAgICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHV0aWxpdHkgbWV0aG9kIHRvIGNvbnZlcnQgTEUgdG8gYW4gdW5zaWduZWQgMTYtYml0IGludGVnZXIgdmFsdWVzLlxuICAgKlxuICAgKiBAcGFyYW0gZGF0YSBUaGUgRGF0YVZpZXcgYmluYXJ5IGRhdGEuXG4gICAqIEBwYXJhbSBieXRlT2Zmc2V0IFRoZSBvZmZzZXQsIGluIGJ5dGUsIGZyb20gdGhlIHN0YXJ0IG9mIHRoZSB2aWV3IHdoZXJlIHRvIHJlYWQgdGhlIGRhdGEuXG4gICAqIEByZXR1cm4gQW4gdW5zaWduZWQgMTYtYml0IGludGVnZXIgbnVtYmVyLlxuICAgKi9cbiAgbGl0dGxlRW5kaWFuVG9VaW50MTYoZGF0YTogYW55LCBieXRlT2Zmc2V0OiBudW1iZXIpOiBudW1iZXIge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1iaXR3aXNlXG4gICAgcmV0dXJuICh0aGlzLmxpdHRsZUVuZGlhblRvVWludDgoZGF0YSwgYnl0ZU9mZnNldCArIDEpIDw8IDgpICsgdGhpcy5saXR0bGVFbmRpYW5Ub1VpbnQ4KGRhdGEsIGJ5dGVPZmZzZXQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgdXRpbGl0eSBtZXRob2QgdG8gY29udmVydCBMRSB0byBhbiB1bnNpZ25lZCA4LWJpdCBpbnRlZ2VyIHZhbHVlcy5cbiAgICpcbiAgICogQHBhcmFtIGRhdGEgVGhlIERhdGFWaWV3IGJpbmFyeSBkYXRhLlxuICAgKiBAcGFyYW0gYnl0ZU9mZnNldCBUaGUgb2Zmc2V0LCBpbiBieXRlLCBmcm9tIHRoZSBzdGFydCBvZiB0aGUgdmlldyB3aGVyZSB0byByZWFkIHRoZSBkYXRhLlxuICAgKiBAcmV0dXJuIEFuIHVuc2lnbmVkIDgtYml0IGludGVnZXIgbnVtYmVyLlxuICAgKi9cbiAgbGl0dGxlRW5kaWFuVG9VaW50OChkYXRhOiBhbnksIGJ5dGVPZmZzZXQ6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIGRhdGEuZ2V0VWludDgoYnl0ZU9mZnNldCk7XG4gIH1cblxuICAvKipcbiAgICogU2VuZHMgcmFuZG9tIGRhdGEgKGZvciB0ZXN0aW5nIHB1cnBvc2VzIG9ubHkpLlxuICAgKlxuICAgKiBAcmV0dXJuIFJhbmRvbSB1bnNpZ25lZCA4LWJpdCBpbnRlZ2VyIHZhbHVlcy5cbiAgICovXG4gIGZha2VOZXh0KGZha2VWYWx1ZT86ICgpID0+IERhdGFWaWV3KSB7XG4gICAgaWYgKGZha2VWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBmYWtlVmFsdWUgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGR2ID0gbmV3IERhdGFWaWV3KG5ldyBBcnJheUJ1ZmZlcig4KSk7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1iaXR3aXNlXG4gICAgICAgIGR2LnNldFVpbnQ4KDAsIChNYXRoLnJhbmRvbSgpICogMTEwKSB8IDApO1xuICAgICAgICByZXR1cm4gZHY7XG4gICAgICB9O1xuICAgIH1cblxuICAgIHRoaXMuY2hhcmFjdGVyaXN0aWNWYWx1ZUNoYW5nZXMkLmVtaXQoZmFrZVZhbHVlKCkpO1xuICB9XG59XG4iXX0=