/**
 * @fileoverview added by tsickle
 * Generated from: lib/bluetooth.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { __awaiter, __generator, __read, __spread } from "tslib";
import { EventEmitter, Injectable } from '@angular/core';
import { from, fromEvent, throwError } from 'rxjs';
import { filter, map, mergeMap, takeUntil } from 'rxjs/operators';
import { ConsoleLoggerService } from './logger.service';
import { BrowserWebBluetooth } from './platform/browser';
import * as i0 from "@angular/core";
import * as i1 from "./platform/browser";
import * as i2 from "./logger.service";
var BluetoothCore = /** @class */ (function () {
    function BluetoothCore(webBle, console) {
        this.webBle = webBle;
        this.console = console;
        this.device$ = new EventEmitter();
        this.gatt$ = new EventEmitter();
        this.characteristicValueChanges$ = new EventEmitter();
        this.gattServer = null;
    }
    /**
     * @return {?}
     */
    BluetoothCore.prototype.getDevice$ = /**
     * @return {?}
     */
    function () {
        return this.device$;
    };
    /**
     * @return {?}
     */
    BluetoothCore.prototype.getGATT$ = /**
     * @return {?}
     */
    function () {
        return this.gatt$;
    };
    /**
     * @return {?}
     */
    BluetoothCore.prototype.streamValues$ = /**
     * @return {?}
     */
    function () {
        return this.characteristicValueChanges$.pipe(filter((/**
         * @param {?} value
         * @return {?}
         */
        function (value) { return value && value.byteLength > 0; })));
    };
    /**
     * Run the discovery process and read the value form the provided service and characteristic
     * @param options the ReadValueOptions
     */
    /**
     * Run the discovery process and read the value form the provided service and characteristic
     * @param {?} options the ReadValueOptions
     * @return {?}
     */
    BluetoothCore.prototype.value = /**
     * Run the discovery process and read the value form the provided service and characteristic
     * @param {?} options the ReadValueOptions
     * @return {?}
     */
    function (options) {
        return __awaiter(this, void 0, void 0, function () {
            var device, gatt, primaryService, characteristic, value, error_1;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.console.log('[BLE::Info] Reading value with options %o', options);
                        if (typeof options.acceptAllDevices === 'undefined') {
                            options.acceptAllDevices = true;
                        }
                        if (typeof options.optionalServices === 'undefined') {
                            options.optionalServices = [options.service];
                        }
                        else {
                            options.optionalServices = __spread(options.optionalServices);
                        }
                        this.console.log('[BLE::Info] Reading value with options %o', options);
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 7, , 8]);
                        return [4 /*yield*/, this.discover({
                                acceptAllDevices: options.acceptAllDevices,
                                optionalServices: options.optionalServices
                            })];
                    case 2:
                        device = (/** @type {?} */ (_a.sent()));
                        this.console.log('[BLE::Info] Device info %o', device);
                        return [4 /*yield*/, this.connectDevice(device)];
                    case 3:
                        gatt = _a.sent();
                        this.console.log('[BLE::Info] GATT info %o', gatt);
                        return [4 /*yield*/, this.getPrimaryService(gatt, options.service)];
                    case 4:
                        primaryService = (/** @type {?} */ (_a.sent()));
                        this.console.log('[BLE::Info] Primary Service info %o', primaryService);
                        return [4 /*yield*/, this.getCharacteristic(primaryService, options.characteristic)];
                    case 5:
                        characteristic = (/** @type {?} */ (_a.sent()));
                        this.console.log('[BLE::Info] Characteristic info %o', characteristic);
                        return [4 /*yield*/, characteristic.readValue()];
                    case 6:
                        value = _a.sent();
                        this.console.log('[BLE::Info] Value info %o', value);
                        return [2 /*return*/, value];
                    case 7:
                        error_1 = _a.sent();
                        throw new Error(error_1);
                    case 8: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * @param {?} options
     * @return {?}
     */
    BluetoothCore.prototype.value$ = /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        return from(this.value(options));
    };
    /**
     * Run the discovery process.
     *
     * @param Options such as filters and optional services
     * @return  The GATT server for the chosen device
     */
    /**
     * Run the discovery process.
     *
     * @param {?=} options
     * @return {?} The GATT server for the chosen device
     */
    BluetoothCore.prototype.discover = /**
     * Run the discovery process.
     *
     * @param {?=} options
     * @return {?} The GATT server for the chosen device
     */
    function (options) {
        if (options === void 0) { options = (/** @type {?} */ ({})); }
        return __awaiter(this, void 0, void 0, function () {
            var device, error_2;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        options.optionalServices = options.optionalServices || ['generic_access'];
                        this.console.log('[BLE::Info] Requesting devices with options %o', options);
                        device = null;
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, this.webBle.requestDevice(options)];
                    case 2:
                        device = _a.sent();
                        device.addEventListener('gattserverdisconnected', this.onDeviceDisconnected.bind(this));
                        if (device) {
                            this.device$.emit(device);
                        }
                        else {
                            this.device$.error("[BLE::Error] Can not get the Bluetooth Remote GATT Server. Abort.");
                        }
                        return [3 /*break*/, 4];
                    case 3:
                        error_2 = _a.sent();
                        this.console.error(error_2);
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/, device];
                }
            });
        });
    };
    /**
     * This handler will trigger when the client disconnets from the server.
     *
     * @param event The onDeviceDisconnected event
     */
    /**
     * This handler will trigger when the client disconnets from the server.
     *
     * @param {?} event The onDeviceDisconnected event
     * @return {?}
     */
    BluetoothCore.prototype.onDeviceDisconnected = /**
     * This handler will trigger when the client disconnets from the server.
     *
     * @param {?} event The onDeviceDisconnected event
     * @return {?}
     */
    function (event) {
        /** @type {?} */
        var disconnectedDevice = (/** @type {?} */ (event.target));
        this.console.log('[BLE::Info] disconnected device %o', disconnectedDevice);
        this.device$.emit(null);
    };
    /**
     * Run the discovery process.
     *
     * @param Options such as filters and optional services
     * @return  Emites the value of the requested service read from the device
     */
    /**
     * Run the discovery process.
     *
     * @param {?=} options
     * @return {?} Emites the value of the requested service read from the device
     */
    BluetoothCore.prototype.discover$ = /**
     * Run the discovery process.
     *
     * @param {?=} options
     * @return {?} Emites the value of the requested service read from the device
     */
    function (options) {
        var _this = this;
        return from(this.discover(options)).pipe(mergeMap((/**
         * @param {?} device
         * @return {?}
         */
        function (device) { return _this.connectDevice$(device); })));
    };
    /**
     * Connect to current device.
     *
     * @return  Emites the gatt server instance of the requested device
     */
    /**
     * Connect to current device.
     *
     * @param {?} device
     * @return {?} Emites the gatt server instance of the requested device
     */
    BluetoothCore.prototype.connectDevice = /**
     * Connect to current device.
     *
     * @param {?} device
     * @return {?} Emites the gatt server instance of the requested device
     */
    function (device) {
        return __awaiter(this, void 0, void 0, function () {
            var gattServer, error_3;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!device) return [3 /*break*/, 5];
                        this.console.log('[BLE::Info] Connecting to Bluetooth Remote GATT Server of %o', device);
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, device.gatt.connect()];
                    case 2:
                        gattServer = _a.sent();
                        this.gattServer = gattServer;
                        this.gatt$.emit(gattServer);
                        return [2 /*return*/, gattServer];
                    case 3:
                        error_3 = _a.sent();
                        // probably the user has canceled the discovery
                        Promise.reject("" + error_3.message);
                        this.gatt$.error("" + error_3.message);
                        return [3 /*break*/, 4];
                    case 4: return [3 /*break*/, 6];
                    case 5:
                        this.console.error('[BLE::Error] Was not able to connect to Bluetooth Remote GATT Server');
                        this.gatt$.error(null);
                        _a.label = 6;
                    case 6: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Connect to current device.
     *
     * @return  Emites the gatt server instance of the requested device
     */
    /**
     * Connect to current device.
     *
     * @param {?} device
     * @return {?} Emites the gatt server instance of the requested device
     */
    BluetoothCore.prototype.connectDevice$ = /**
     * Connect to current device.
     *
     * @param {?} device
     * @return {?} Emites the gatt server instance of the requested device
     */
    function (device) {
        return from(this.connectDevice(device));
    };
    /**
     * Disconnect the current connected device
     */
    /**
     * Disconnect the current connected device
     * @return {?}
     */
    BluetoothCore.prototype.disconnectDevice = /**
     * Disconnect the current connected device
     * @return {?}
     */
    function () {
        if (!this.gattServer) {
            return;
        }
        this.console.log('[BLE::Info] Disconnecting from Bluetooth Device %o', this.gattServer);
        if (this.gattServer.connected) {
            this.gattServer.disconnect();
        }
        else {
            this.console.log('[BLE::Info] Bluetooth device is already disconnected');
        }
    };
    /**
     * Requests the primary service.
     *
     * @param gatt The BluetoothRemoteGATTServer sever
     * @param service The UUID of the primary service
     * @return The remote service (as a Promise)
     */
    /**
     * Requests the primary service.
     *
     * @param {?} gatt The BluetoothRemoteGATTServer sever
     * @param {?} service The UUID of the primary service
     * @return {?} The remote service (as a Promise)
     */
    BluetoothCore.prototype.getPrimaryService = /**
     * Requests the primary service.
     *
     * @param {?} gatt The BluetoothRemoteGATTServer sever
     * @param {?} service The UUID of the primary service
     * @return {?} The remote service (as a Promise)
     */
    function (gatt, service) {
        return __awaiter(this, void 0, void 0, function () {
            var remoteService, error_4;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 5]);
                        return [4 /*yield*/, gatt.getPrimaryService(service)];
                    case 1:
                        remoteService = _a.sent();
                        return [4 /*yield*/, Promise.resolve(remoteService)];
                    case 2: return [2 /*return*/, _a.sent()];
                    case 3:
                        error_4 = _a.sent();
                        return [4 /*yield*/, Promise.reject(error_4.message + " (" + service + ")")];
                    case 4: return [2 /*return*/, _a.sent()];
                    case 5: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Requests the primary service.
     *
     * @param gatt The BluetoothRemoteGATTServer sever
     * @param service The UUID of the primary service
     * @return The remote service (as an observable).
     */
    /**
     * Requests the primary service.
     *
     * @param {?} gatt The BluetoothRemoteGATTServer sever
     * @param {?} service The UUID of the primary service
     * @return {?} The remote service (as an observable).
     */
    BluetoothCore.prototype.getPrimaryService$ = /**
     * Requests the primary service.
     *
     * @param {?} gatt The BluetoothRemoteGATTServer sever
     * @param {?} service The UUID of the primary service
     * @return {?} The remote service (as an observable).
     */
    function (gatt, service) {
        this.console.log('[BLE::Info] Getting primary service "%s" (if available) of %o', service, gatt);
        if (gatt) {
            return from(this.getPrimaryService(gatt, service));
        }
        else {
            return throwError(new Error('[BLE::Error] Was not able to connect to the Bluetooth Remote GATT Server'));
        }
    };
    /**
     * Requests a characteristic from the primary service.
     *
     * @param primaryService The primary service.
     * @param characteristic The characteristic's UUID.
     * @returns The characteristic description (as a Promise).
     */
    /**
     * Requests a characteristic from the primary service.
     *
     * @param {?} primaryService The primary service.
     * @param {?} characteristic The characteristic's UUID.
     * @return {?} The characteristic description (as a Promise).
     */
    BluetoothCore.prototype.getCharacteristic = /**
     * Requests a characteristic from the primary service.
     *
     * @param {?} primaryService The primary service.
     * @param {?} characteristic The characteristic's UUID.
     * @return {?} The characteristic description (as a Promise).
     */
    function (primaryService, characteristic) {
        return __awaiter(this, void 0, void 0, function () {
            var char_1, rejectionError_1;
            var _this = this;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.console.log('[BLE::Info] Getting Characteristic "%s" of %o', characteristic, primaryService);
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, primaryService.getCharacteristic(characteristic)];
                    case 2:
                        char_1 = _a.sent();
                        // listen for characteristic value changes
                        if (char_1.properties.notify) {
                            char_1.startNotifications().then((/**
                             * @param {?} _
                             * @return {?}
                             */
                            function (_) {
                                _this.console.log('[BLE::Info] Starting notifications of "%s"', characteristic);
                                char_1.addEventListener('characteristicvaluechanged', _this.onCharacteristicChanged.bind(_this));
                            }), (/**
                             * @param {?} error
                             * @return {?}
                             */
                            function (error) {
                                Promise.reject(error.message + " (" + characteristic + ")");
                            }));
                        }
                        else {
                            char_1.addEventListener('characteristicvaluechanged', this.onCharacteristicChanged.bind(this));
                        }
                        return [2 /*return*/, char_1];
                    case 3:
                        rejectionError_1 = _a.sent();
                        Promise.reject(rejectionError_1.message + " (" + characteristic + ")");
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Requests a characteristic from the primary service.
     *
     * @param primaryService The primary service.
     * @param characteristic The characteristic's UUID.
     * @returns The characteristic description (as a Observable).
     */
    /**
     * Requests a characteristic from the primary service.
     *
     * @param {?} primaryService The primary service.
     * @param {?} characteristic The characteristic's UUID.
     * @return {?} The characteristic description (as a Observable).
     */
    BluetoothCore.prototype.getCharacteristic$ = /**
     * Requests a characteristic from the primary service.
     *
     * @param {?} primaryService The primary service.
     * @param {?} characteristic The characteristic's UUID.
     * @return {?} The characteristic description (as a Observable).
     */
    function (primaryService, characteristic) {
        this.console.log('[BLE::Info] Getting Characteristic "%s" of %o', characteristic, primaryService);
        return from(this.getCharacteristic(primaryService, characteristic));
    };
    /**
     * Sets the characteristic's state.
     *
     * @param service The parent service of the characteristic.
     * @param characteristic The requested characteristic
     * @param state An ArrayBuffer containing the value of the characteristic.
     * @return The primary service (useful for chaining).
     */
    /**
     * Sets the characteristic's state.
     *
     * @param {?} service The parent service of the characteristic.
     * @param {?} characteristic The requested characteristic
     * @param {?} state An ArrayBuffer containing the value of the characteristic.
     * @return {?} The primary service (useful for chaining).
     */
    BluetoothCore.prototype.setCharacteristicState = /**
     * Sets the characteristic's state.
     *
     * @param {?} service The parent service of the characteristic.
     * @param {?} characteristic The requested characteristic
     * @param {?} state An ArrayBuffer containing the value of the characteristic.
     * @return {?} The primary service (useful for chaining).
     */
    function (service, characteristic, state) {
        var _this = this;
        /** @type {?} */
        var primaryService = this.getPrimaryService$(this.gattServer, service);
        primaryService
            // tslint:disable-next-line: variable-name
            .pipe(mergeMap((/**
         * @param {?} _primaryService
         * @return {?}
         */
        function (_primaryService) { return _this.getCharacteristic$(_primaryService, characteristic); })))
            // tslint:disable-next-line: no-shadowed-variable
            .subscribe((/**
         * @param {?} characteristic
         * @return {?}
         */
        function (characteristic) { return _this.writeValue$(characteristic, state); }));
        return primaryService;
    };
    /**
     * Enables the specified characteristic of a given service.
     *
     * @param service The parent service of the characteristic.
     * @param characteristic The requested characteristic
     * @return The primary service (useful for chaining).
     */
    /**
     * Enables the specified characteristic of a given service.
     *
     * @param {?} service The parent service of the characteristic.
     * @param {?} characteristic The requested characteristic
     * @param {?=} state
     * @return {?} The primary service (useful for chaining).
     */
    BluetoothCore.prototype.enableCharacteristic = /**
     * Enables the specified characteristic of a given service.
     *
     * @param {?} service The parent service of the characteristic.
     * @param {?} characteristic The requested characteristic
     * @param {?=} state
     * @return {?} The primary service (useful for chaining).
     */
    function (service, characteristic, state) {
        state = state || new Uint8Array([1]);
        return this.setCharacteristicState(service, characteristic, state);
    };
    /**
     * Disables the specified characteristic of a given service.
     *
     * @param service The parent service of the characteristic.
     * @param characteristic The requested characteristic.
     * @return The primary service (useful for chaining).
     */
    /**
     * Disables the specified characteristic of a given service.
     *
     * @param {?} service The parent service of the characteristic.
     * @param {?} characteristic The requested characteristic.
     * @param {?=} state
     * @return {?} The primary service (useful for chaining).
     */
    BluetoothCore.prototype.disbaleCharacteristic = /**
     * Disables the specified characteristic of a given service.
     *
     * @param {?} service The parent service of the characteristic.
     * @param {?} characteristic The requested characteristic.
     * @param {?=} state
     * @return {?} The primary service (useful for chaining).
     */
    function (service, characteristic, state) {
        state = state || new Uint8Array([0]);
        return this.setCharacteristicState(service, characteristic, state);
    };
    /**
     * Dispatches new values emitted by a characteristic.
     *
     * @param event the distpatched event.
     */
    /**
     * Dispatches new values emitted by a characteristic.
     *
     * @param {?} event the distpatched event.
     * @return {?}
     */
    BluetoothCore.prototype.onCharacteristicChanged = /**
     * Dispatches new values emitted by a characteristic.
     *
     * @param {?} event the distpatched event.
     * @return {?}
     */
    function (event) {
        this.console.log('[BLE::Info] Dispatching new characteristic value %o', event);
        /** @type {?} */
        var value = ((/** @type {?} */ (event.target))).value;
        this.characteristicValueChanges$.emit(value);
    };
    /**
     * Reads a value from the characteristics, as a DataView.
     *
     * @param characteristic The requested characteristic.
     * @return the DataView value (as an Observable).
     */
    /**
     * Reads a value from the characteristics, as a DataView.
     *
     * @param {?} characteristic The requested characteristic.
     * @return {?} the DataView value (as an Observable).
     */
    BluetoothCore.prototype.readValue$ = /**
     * Reads a value from the characteristics, as a DataView.
     *
     * @param {?} characteristic The requested characteristic.
     * @return {?} the DataView value (as an Observable).
     */
    function (characteristic) {
        this.console.log('[BLE::Info] Reading Characteristic %o', characteristic);
        return from(characteristic
            .readValue()
            .then((/**
         * @param {?} data
         * @return {?}
         */
        function (data) { return Promise.resolve(data); }), (/**
         * @param {?} error
         * @return {?}
         */
        function (error) { return Promise.reject("" + error.message); })));
    };
    /**
     * Writes a value into the specified characteristic.
     *
     * @param characteristic The requested characteristic.
     * @param value The value to be written (as an ArrayBuffer or Uint8Array).
     * @return an void Observable.
     */
    /**
     * Writes a value into the specified characteristic.
     *
     * @param {?} characteristic The requested characteristic.
     * @param {?} value The value to be written (as an ArrayBuffer or Uint8Array).
     * @return {?} an void Observable.
     */
    BluetoothCore.prototype.writeValue$ = /**
     * Writes a value into the specified characteristic.
     *
     * @param {?} characteristic The requested characteristic.
     * @param {?} value The value to be written (as an ArrayBuffer or Uint8Array).
     * @return {?} an void Observable.
     */
    function (characteristic, value) {
        this.console.log('[BLE::Info] Writing Characteristic %o', characteristic);
        return from(characteristic.writeValue(value).then((/**
         * @param {?} _
         * @return {?}
         */
        function (_) { return Promise.resolve(); }), (/**
         * @param {?} error
         * @return {?}
         */
        function (error) { return Promise.reject("" + error.message); })));
    };
    /**
     * A stream of DataView values emitted by the specified characteristic.
     *
     * @param characteristic The characteristic which value you want to observe
     * @return The stream of DataView values.
     */
    /**
     * A stream of DataView values emitted by the specified characteristic.
     *
     * @param {?} characteristic The characteristic which value you want to observe
     * @return {?} The stream of DataView values.
     */
    BluetoothCore.prototype.observeValue$ = /**
     * A stream of DataView values emitted by the specified characteristic.
     *
     * @param {?} characteristic The characteristic which value you want to observe
     * @return {?} The stream of DataView values.
     */
    function (characteristic) {
        characteristic.startNotifications();
        /** @type {?} */
        var disconnected = fromEvent(characteristic.service.device, 'gattserverdisconnected');
        return fromEvent(characteristic, 'characteristicvaluechanged')
            .pipe(map((/**
         * @param {?} event
         * @return {?}
         */
        function (event) { return (/** @type {?} */ (((/** @type {?} */ (event.target))).value)); })), takeUntil(disconnected));
    };
    /**
     * A utility method to convert LE to an unsigned 16-bit integer values.
     *
     * @param data The DataView binary data.
     * @param byteOffset The offset, in byte, from the start of the view where to read the data.
     * @return An unsigned 16-bit integer number.
     */
    /**
     * A utility method to convert LE to an unsigned 16-bit integer values.
     *
     * @param {?} data The DataView binary data.
     * @param {?} byteOffset The offset, in byte, from the start of the view where to read the data.
     * @return {?} An unsigned 16-bit integer number.
     */
    BluetoothCore.prototype.littleEndianToUint16 = /**
     * A utility method to convert LE to an unsigned 16-bit integer values.
     *
     * @param {?} data The DataView binary data.
     * @param {?} byteOffset The offset, in byte, from the start of the view where to read the data.
     * @return {?} An unsigned 16-bit integer number.
     */
    function (data, byteOffset) {
        // tslint:disable-next-line:no-bitwise
        return (this.littleEndianToUint8(data, byteOffset + 1) << 8) + this.littleEndianToUint8(data, byteOffset);
    };
    /**
     * A utility method to convert LE to an unsigned 8-bit integer values.
     *
     * @param data The DataView binary data.
     * @param byteOffset The offset, in byte, from the start of the view where to read the data.
     * @return An unsigned 8-bit integer number.
     */
    /**
     * A utility method to convert LE to an unsigned 8-bit integer values.
     *
     * @param {?} data The DataView binary data.
     * @param {?} byteOffset The offset, in byte, from the start of the view where to read the data.
     * @return {?} An unsigned 8-bit integer number.
     */
    BluetoothCore.prototype.littleEndianToUint8 = /**
     * A utility method to convert LE to an unsigned 8-bit integer values.
     *
     * @param {?} data The DataView binary data.
     * @param {?} byteOffset The offset, in byte, from the start of the view where to read the data.
     * @return {?} An unsigned 8-bit integer number.
     */
    function (data, byteOffset) {
        return data.getUint8(byteOffset);
    };
    /**
     * Sends random data (for testing purposes only).
     *
     * @return Random unsigned 8-bit integer values.
     */
    /**
     * Sends random data (for testing purposes only).
     *
     * @param {?=} fakeValue
     * @return {?} Random unsigned 8-bit integer values.
     */
    BluetoothCore.prototype.fakeNext = /**
     * Sends random data (for testing purposes only).
     *
     * @param {?=} fakeValue
     * @return {?} Random unsigned 8-bit integer values.
     */
    function (fakeValue) {
        if (fakeValue === undefined) {
            fakeValue = (/**
             * @return {?}
             */
            function () {
                /** @type {?} */
                var dv = new DataView(new ArrayBuffer(8));
                // tslint:disable-next-line:no-bitwise
                dv.setUint8(0, (Math.random() * 110) | 0);
                return dv;
            });
        }
        this.characteristicValueChanges$.emit(fakeValue());
    };
    BluetoothCore.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    BluetoothCore.ctorParameters = function () { return [
        { type: BrowserWebBluetooth },
        { type: ConsoleLoggerService }
    ]; };
    /** @nocollapse */ BluetoothCore.ɵprov = i0.ɵɵdefineInjectable({ factory: function BluetoothCore_Factory() { return new BluetoothCore(i0.ɵɵinject(i1.BrowserWebBluetooth), i0.ɵɵinject(i2.ConsoleLoggerService)); }, token: BluetoothCore, providedIn: "root" });
    return BluetoothCore;
}());
export { BluetoothCore };
if (false) {
    /**
     * @type {?}
     * @private
     */
    BluetoothCore.prototype.device$;
    /**
     * @type {?}
     * @private
     */
    BluetoothCore.prototype.gatt$;
    /**
     * @type {?}
     * @private
     */
    BluetoothCore.prototype.characteristicValueChanges$;
    /**
     * @type {?}
     * @private
     */
    BluetoothCore.prototype.gattServer;
    /**
     * @type {?}
     * @private
     */
    BluetoothCore.prototype.webBle;
    /**
     * @type {?}
     * @private
     */
    BluetoothCore.prototype.console;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmx1ZXRvb3RoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbWFuZWtpbmVra28vYW5ndWxhci13ZWItYmx1ZXRvb3RoLyIsInNvdXJjZXMiOlsibGliL2JsdWV0b290aC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvRCxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7Ozs7QUFTekQ7SUFTRSx1QkFBNkIsTUFBMkIsRUFBbUIsT0FBNkI7UUFBM0UsV0FBTSxHQUFOLE1BQU0sQ0FBcUI7UUFBbUIsWUFBTyxHQUFQLE9BQU8sQ0FBc0I7UUFFdEcsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLFlBQVksRUFBbUIsQ0FBQztRQUNuRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksWUFBWSxFQUE2QixDQUFDO1FBQzNELElBQUksQ0FBQywyQkFBMkIsR0FBRyxJQUFJLFlBQVksRUFBWSxDQUFDO1FBRWhFLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO0lBQ3pCLENBQUM7Ozs7SUFFRCxrQ0FBVTs7O0lBQVY7UUFDRSxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQzs7OztJQUVELGdDQUFROzs7SUFBUjtRQUNFLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDOzs7O0lBRUQscUNBQWE7OztJQUFiO1FBQ0UsT0FBTyxJQUFJLENBQUMsMkJBQTJCLENBQUMs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QUc7O29CQUNKLEVBQUUsR0FBRyxJQUFJLFFBQVEsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDM0Msc0NBQXNDO2dCQUN0QyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDMUMsT0FBTyxFQUFFLENBQUM7WUFDWixDQUFDLENBQUEsQ0FBQztTQUNIO1FBRUQsSUFBSSxDQUFDLDJCQUEyQixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQ3JELENBQUM7O2dCQTFaRixVQUFVLFNBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzs7O2dCQVhRLG1CQUFtQjtnQkFEbkIsb0JBQW9COzs7d0JBSDdCO0NBd2FDLEFBM1pELElBMlpDO1NBeFpZLGFBQWE7Ozs7OztJQUN4QixnQ0FBK0M7Ozs7O0lBQy9DLDhCQUF1RDs7Ozs7SUFDdkQsb0RBQTREOzs7OztJQUM1RCxtQ0FBOEM7Ozs7O0lBRWxDLCtCQUE0Qzs7Ozs7SUFBRSxnQ0FBOEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZyb20sIGZyb21FdmVudCwgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIG1lcmdlTWFwLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDb25zb2xlTG9nZ2VyU2VydmljZSB9IGZyb20gJy4vbG9nZ2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgQnJvd3NlcldlYkJsdWV0b290aCB9IGZyb20gJy4vcGxhdGZvcm0vYnJvd3Nlcic7XG5cbnR5cGUgUmVhZFZhbHVlT3B0aW9ucyA9IHtcbiAgYWNjZXB0QWxsRGV2aWNlcz86IGJvb2xlYW47XG4gIG9wdGlvbmFsU2VydmljZXM/OiBCbHVldG9vdGhTZXJ2aWNlVVVJRFtdO1xuICBjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoQ2hhcmFjdGVyaXN0aWNVVUlELFxuICBzZXJ2aWNlOiBCbHVldG9vdGhTZXJ2aWNlVVVJRCxcbn07XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEJsdWV0b290aENvcmUge1xuICBwcml2YXRlIGRldmljZSQ6IEV2ZW50RW1pdHRlcjxCbHVldG9vdGhEZXZpY2U+O1xuICBwcml2YXRlIGdhdHQkOiBFdmVudEVtaXR0ZXI8Qmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZlcj47XG4gIHByaXZhdGUgY2hhcmFjdGVyaXN0aWNWYWx1ZUNoYW5nZXMkOiBFdmVudEVtaXR0ZXI8RGF0YVZpZXc+O1xuICBwcml2YXRlIGdhdHRTZXJ2ZXI6IEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2ZXI7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSB3ZWJCbGU6IEJyb3dzZXJXZWJCbHVldG9vdGgsIHByaXZhdGUgcmVhZG9ubHkgY29uc29sZTogQ29uc29sZUxvZ2dlclNlcnZpY2UpIHtcblxuICAgIHRoaXMuZGV2aWNlJCA9IG5ldyBFdmVudEVtaXR0ZXI8Qmx1ZXRvb3RoRGV2aWNlPigpO1xuICAgIHRoaXMuZ2F0dCQgPSBuZXcgRXZlbnRFbWl0dGVyPEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2ZXI+KCk7XG4gICAgdGhpcy5jaGFyYWN0ZXJpc3RpY1ZhbHVlQ2hhbmdlcyQgPSBuZXcgRXZlbnRFbWl0dGVyPERhdGFWaWV3PigpO1xuXG4gICAgdGhpcy5nYXR0U2VydmVyID0gbnVsbDtcbiAgfVxuXG4gIGdldERldmljZSQoKTogT2JzZXJ2YWJsZTxCbHVldG9vdGhEZXZpY2U+IHtcbiAgICByZXR1cm4gdGhpcy5kZXZpY2UkO1xuICB9XG5cbiAgZ2V0R0FUVCQoKTogT2JzZXJ2YWJsZTxCbHVldG9vdGhSZW1vdGVHQVRUU2VydmVyPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2F0dCQ7XG4gIH1cblxuICBzdHJlYW1WYWx1ZXMkKCk6IE9ic2VydmFibGU8RGF0YVZpZXc+IHtcbiAgICByZXR1cm4gdGhpcy5jaGFyYWN0ZXJpc3RpY1ZhbHVlQ2hhbmdlcyQucGlwZShmaWx0ZXIodmFsdWUgPT4gdmFsdWUgJiYgdmFsdWUuYnl0ZUxlbmd0aCA+IDApKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gdGhlIGRpc2NvdmVyeSBwcm9jZXNzIGFuZCByZWFkIHRoZSB2YWx1ZSBmb3JtIHRoZSBwcm92aWRlZCBzZXJ2aWNlIGFuZCBjaGFyYWN0ZXJpc3RpY1xuICAgKiBAcGFyYW0gb3B0aW9ucyB0aGUgUmVhZFZhbHVlT3B0aW9uc1xuICAgKi9cbiAgYXN5bmMgdmFsdWUob3B0aW9uczogUmVhZFZhbHVlT3B0aW9ucykge1xuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIFJlYWRpbmcgdmFsdWUgd2l0aCBvcHRpb25zICVvJywgb3B0aW9ucyk7XG5cbiAgICBpZiAodHlwZW9mIG9wdGlvbnMuYWNjZXB0QWxsRGV2aWNlcyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIG9wdGlvbnMuYWNjZXB0QWxsRGV2aWNlcyA9IHRydWU7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zLm9wdGlvbmFsU2VydmljZXMgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBvcHRpb25zLm9wdGlvbmFsU2VydmljZXMgPSBbb3B0aW9ucy5zZXJ2aWNlXTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBvcHRpb25zLm9wdGlvbmFsU2VydmljZXMgPSBbLi4ub3B0aW9ucy5vcHRpb25hbFNlcnZpY2VzXTtcbiAgICB9XG5cbiAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBSZWFkaW5nIHZhbHVlIHdpdGggb3B0aW9ucyAlbycsIG9wdGlvbnMpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRldmljZSA9IGF3YWl0IHRoaXMuZGlzY292ZXIoe1xuICAgICAgICBhY2NlcHRBbGxEZXZpY2VzOiBvcHRpb25zLmFjY2VwdEFsbERldmljZXMsXG4gICAgICAgIG9wdGlvbmFsU2VydmljZXM6IG9wdGlvbnMub3B0aW9uYWxTZXJ2aWNlc1xuICAgICAgfSkgYXMgQmx1ZXRvb3RoRGV2aWNlO1xuICAgICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gRGV2aWNlIGluZm8gJW8nLCBkZXZpY2UpO1xuXG4gICAgICBjb25zdCBnYXR0ID0gYXdhaXQgdGhpcy5jb25uZWN0RGV2aWNlKGRldmljZSk7XG4gICAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBHQVRUIGluZm8gJW8nLCBnYXR0KTtcblxuICAgICAgY29uc3QgcHJpbWFyeVNlcnZpY2UgPSBhd2FpdCB0aGlzLmdldFByaW1hcnlTZXJ2aWNlKGdhdHQsIG9wdGlvbnMuc2VydmljZSkgYXMgQmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZpY2U7XG4gICAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBQcmltYXJ5IFNlcnZpY2UgaW5mbyAlbycsIHByaW1hcnlTZXJ2aWNlKTtcblxuICAgICAgY29uc3QgY2hhcmFjdGVyaXN0aWMgPSBhd2FpdCB0aGlzLmdldENoYXJhY3RlcmlzdGljKHByaW1hcnlTZXJ2aWNlLCBvcHRpb25zLmNoYXJhY3RlcmlzdGljKSBhcyBCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWM7XG4gICAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBDaGFyYWN0ZXJpc3RpYyBpbmZvICVvJywgY2hhcmFjdGVyaXN0aWMpO1xuXG4gICAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IGNoYXJhY3RlcmlzdGljLnJlYWRWYWx1ZSgpO1xuICAgICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gVmFsdWUgaW5mbyAlbycsIHZhbHVlKTtcblxuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgdmFsdWUkKG9wdGlvbnM6IFJlYWRWYWx1ZU9wdGlvbnMpIHtcbiAgICByZXR1cm4gZnJvbSh0aGlzLnZhbHVlKG9wdGlvbnMpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSdW4gdGhlIGRpc2NvdmVyeSBwcm9jZXNzLlxuICAgKlxuICAgKiBAcGFyYW0gT3B0aW9ucyBzdWNoIGFzIGZpbHRlcnMgYW5kIG9wdGlvbmFsIHNlcnZpY2VzXG4gICAqIEByZXR1cm4gIFRoZSBHQVRUIHNlcnZlciBmb3IgdGhlIGNob3NlbiBkZXZpY2VcbiAgICovXG4gIGFzeW5jIGRpc2NvdmVyKG9wdGlvbnM6IFJlcXVlc3REZXZpY2VPcHRpb25zID0ge30gYXMgUmVxdWVzdERldmljZU9wdGlvbnMpIHtcbiAgICBvcHRpb25zLm9wdGlvbmFsU2VydmljZXMgPSBvcHRpb25zLm9wdGlvbmFsU2VydmljZXMgfHwgWydnZW5lcmljX2FjY2VzcyddO1xuXG4gICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gUmVxdWVzdGluZyBkZXZpY2VzIHdpdGggb3B0aW9ucyAlbycsIG9wdGlvbnMpO1xuXG4gICAgbGV0IGRldmljZSA9IG51bGw7XG4gICAgdHJ5IHtcbiAgICAgIGRldmljZSA9IGF3YWl0IHRoaXMud2ViQmxlLnJlcXVlc3REZXZpY2Uob3B0aW9ucyk7XG4gICAgICBkZXZpY2UuYWRkRXZlbnRMaXN0ZW5lcignZ2F0dHNlcnZlcmRpc2Nvbm5lY3RlZCcsIHRoaXMub25EZXZpY2VEaXNjb25uZWN0ZWQuYmluZCh0aGlzKSk7XG5cbiAgICAgIGlmIChkZXZpY2UpIHtcbiAgICAgICAgdGhpcy5kZXZpY2UkLmVtaXQoZGV2aWNlKTtcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aGlzLmRldmljZSQuZXJyb3IoYFtCTEU6OkVycm9yXSBDYW4gbm90IGdldCB0aGUgQmx1ZXRvb3RoIFJlbW90ZSBHQVRUIFNlcnZlci4gQWJvcnQuYCk7XG4gICAgICB9XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5jb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGV2aWNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgaGFuZGxlciB3aWxsIHRyaWdnZXIgd2hlbiB0aGUgY2xpZW50IGRpc2Nvbm5ldHMgZnJvbSB0aGUgc2VydmVyLlxuICAgKlxuICAgKiBAcGFyYW0gZXZlbnQgVGhlIG9uRGV2aWNlRGlzY29ubmVjdGVkIGV2ZW50XG4gICAqL1xuICBvbkRldmljZURpc2Nvbm5lY3RlZChldmVudDogRXZlbnQpIHtcbiAgICBjb25zdCBkaXNjb25uZWN0ZWREZXZpY2UgPSBldmVudC50YXJnZXQgYXMgQmx1ZXRvb3RoRGV2aWNlO1xuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIGRpc2Nvbm5lY3RlZCBkZXZpY2UgJW8nLCBkaXNjb25uZWN0ZWREZXZpY2UpO1xuXG4gICAgdGhpcy5kZXZpY2UkLmVtaXQobnVsbCk7XG4gIH1cblxuICAvKipcbiAgICogUnVuIHRoZSBkaXNjb3ZlcnkgcHJvY2Vzcy5cbiAgICpcbiAgICogQHBhcmFtIE9wdGlvbnMgc3VjaCBhcyBmaWx0ZXJzIGFuZCBvcHRpb25hbCBzZXJ2aWNlc1xuICAgKiBAcmV0dXJuICBFbWl0ZXMgdGhlIHZhbHVlIG9mIHRoZSByZXF1ZXN0ZWQgc2VydmljZSByZWFkIGZyb20gdGhlIGRldmljZVxuICAgKi9cbiAgZGlzY292ZXIkKG9wdGlvbnM/OiBSZXF1ZXN0RGV2aWNlT3B0aW9ucyk6IE9ic2VydmFibGU8dm9pZCB8IEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2ZXI+IHtcbiAgICByZXR1cm4gZnJvbSh0aGlzLmRpc2NvdmVyKG9wdGlvbnMpKS5waXBlKG1lcmdlTWFwKChkZXZpY2U6IEJsdWV0b290aERldmljZSkgPT4gdGhpcy5jb25uZWN0RGV2aWNlJChkZXZpY2UpKSk7XG4gIH1cblxuICAvKipcbiAgICogQ29ubmVjdCB0byBjdXJyZW50IGRldmljZS5cbiAgICpcbiAgICogQHJldHVybiAgRW1pdGVzIHRoZSBnYXR0IHNlcnZlciBpbnN0YW5jZSBvZiB0aGUgcmVxdWVzdGVkIGRldmljZVxuICAgKi9cbiAgYXN5bmMgY29ubmVjdERldmljZShkZXZpY2U6IEJsdWV0b290aERldmljZSkge1xuICAgIGlmIChkZXZpY2UpIHtcbiAgICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIENvbm5lY3RpbmcgdG8gQmx1ZXRvb3RoIFJlbW90ZSBHQVRUIFNlcnZlciBvZiAlbycsIGRldmljZSk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGdhdHRTZXJ2ZXIgPSBhd2FpdCBkZXZpY2UuZ2F0dC5jb25uZWN0KCk7XG4gICAgICAgIHRoaXMuZ2F0dFNlcnZlciA9IGdhdHRTZXJ2ZXI7XG4gICAgICAgIHRoaXMuZ2F0dCQuZW1pdChnYXR0U2VydmVyKTtcbiAgICAgICAgcmV0dXJuIGdhdHRTZXJ2ZXI7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAvLyBwcm9iYWJseSB0aGUgdXNlciBoYXMgY2FuY2VsZWQgdGhlIGRpc2NvdmVyeVxuICAgICAgICBQcm9taXNlLnJlamVjdChgJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgICB0aGlzLmdhdHQkLmVycm9yKGAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY29uc29sZS5lcnJvcignW0JMRTo6RXJyb3JdIFdhcyBub3QgYWJsZSB0byBjb25uZWN0IHRvIEJsdWV0b290aCBSZW1vdGUgR0FUVCBTZXJ2ZXInKTtcbiAgICAgIHRoaXMuZ2F0dCQuZXJyb3IobnVsbCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENvbm5lY3QgdG8gY3VycmVudCBkZXZpY2UuXG4gICAqXG4gICAqIEByZXR1cm4gIEVtaXRlcyB0aGUgZ2F0dCBzZXJ2ZXIgaW5zdGFuY2Ugb2YgdGhlIHJlcXVlc3RlZCBkZXZpY2VcbiAgICovXG4gIGNvbm5lY3REZXZpY2UkKGRldmljZTogQmx1ZXRvb3RoRGV2aWNlKSB7XG4gICAgcmV0dXJuIGZyb20odGhpcy5jb25uZWN0RGV2aWNlKGRldmljZSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIERpc2Nvbm5lY3QgdGhlIGN1cnJlbnQgY29ubmVjdGVkIGRldmljZVxuICAgKi9cbiAgZGlzY29ubmVjdERldmljZSgpIHtcbiAgICBpZiAoIXRoaXMuZ2F0dFNlcnZlcikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBEaXNjb25uZWN0aW5nIGZyb20gQmx1ZXRvb3RoIERldmljZSAlbycsIHRoaXMuZ2F0dFNlcnZlcik7XG5cbiAgICBpZiAodGhpcy5nYXR0U2VydmVyLmNvbm5lY3RlZCkge1xuICAgICAgdGhpcy5nYXR0U2VydmVyLmRpc2Nvbm5lY3QoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gQmx1ZXRvb3RoIGRldmljZSBpcyBhbHJlYWR5IGRpc2Nvbm5lY3RlZCcpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXF1ZXN0cyB0aGUgcHJpbWFyeSBzZXJ2aWNlLlxuICAgKlxuICAgKiBAcGFyYW0gZ2F0dCBUaGUgQmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZlciBzZXZlclxuICAgKiBAcGFyYW0gc2VydmljZSBUaGUgVVVJRCBvZiB0aGUgcHJpbWFyeSBzZXJ2aWNlXG4gICAqIEByZXR1cm4gVGhlIHJlbW90ZSBzZXJ2aWNlIChhcyBhIFByb21pc2UpXG4gICAqL1xuICBhc3luYyBnZXRQcmltYXJ5U2VydmljZShnYXR0OiBCbHVldG9vdGhSZW1vdGVHQVRUU2VydmVyLCBzZXJ2aWNlOiBCbHVldG9vdGhTZXJ2aWNlVVVJRCk6IFByb21pc2U8Qmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZpY2U+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVtb3RlU2VydmljZSA9IGF3YWl0IGdhdHQuZ2V0UHJpbWFyeVNlcnZpY2Uoc2VydmljZSk7XG4gICAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5yZXNvbHZlKHJlbW90ZVNlcnZpY2UpO1xuICAgIH1cbiAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBhd2FpdCBQcm9taXNlLnJlamVjdChgJHtlcnJvci5tZXNzYWdlfSAoJHtzZXJ2aWNlfSlgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVxdWVzdHMgdGhlIHByaW1hcnkgc2VydmljZS5cbiAgICpcbiAgICogQHBhcmFtIGdhdHQgVGhlIEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2ZXIgc2V2ZXJcbiAgICogQHBhcmFtIHNlcnZpY2UgVGhlIFVVSUQgb2YgdGhlIHByaW1hcnkgc2VydmljZVxuICAgKiBAcmV0dXJuIFRoZSByZW1vdGUgc2VydmljZSAoYXMgYW4gb2JzZXJ2YWJsZSkuXG4gICAqL1xuICBnZXRQcmltYXJ5U2VydmljZSQoZ2F0dDogQmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZlciwgc2VydmljZTogQmx1ZXRvb3RoU2VydmljZVVVSUQpOiBPYnNlcnZhYmxlPEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2aWNlPiB7XG4gICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gR2V0dGluZyBwcmltYXJ5IHNlcnZpY2UgXCIlc1wiIChpZiBhdmFpbGFibGUpIG9mICVvJywgc2VydmljZSwgZ2F0dCk7XG5cblxuICAgIGlmIChnYXR0KSB7XG4gICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgdGhpcy5nZXRQcmltYXJ5U2VydmljZShnYXR0LCBzZXJ2aWNlKVxuICAgICAgKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICByZXR1cm4gdGhyb3dFcnJvcihuZXcgRXJyb3IoJ1tCTEU6OkVycm9yXSBXYXMgbm90IGFibGUgdG8gY29ubmVjdCB0byB0aGUgQmx1ZXRvb3RoIFJlbW90ZSBHQVRUIFNlcnZlcicpKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVxdWVzdHMgYSBjaGFyYWN0ZXJpc3RpYyBmcm9tIHRoZSBwcmltYXJ5IHNlcnZpY2UuXG4gICAqXG4gICAqIEBwYXJhbSBwcmltYXJ5U2VydmljZSBUaGUgcHJpbWFyeSBzZXJ2aWNlLlxuICAgKiBAcGFyYW0gY2hhcmFjdGVyaXN0aWMgVGhlIGNoYXJhY3RlcmlzdGljJ3MgVVVJRC5cbiAgICogQHJldHVybnMgVGhlIGNoYXJhY3RlcmlzdGljIGRlc2NyaXB0aW9uIChhcyBhIFByb21pc2UpLlxuICAgKi9cbiAgYXN5bmMgZ2V0Q2hhcmFjdGVyaXN0aWMoXG4gICAgcHJpbWFyeVNlcnZpY2U6IEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2aWNlLFxuICAgIGNoYXJhY3RlcmlzdGljOiBCbHVldG9vdGhDaGFyYWN0ZXJpc3RpY1VVSURcbiAgKTogUHJvbWlzZTxCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWMgfCB2b2lkPiB7XG4gICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gR2V0dGluZyBDaGFyYWN0ZXJpc3RpYyBcIiVzXCIgb2YgJW8nLCBjaGFyYWN0ZXJpc3RpYywgcHJpbWFyeVNlcnZpY2UpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNoYXIgPSBhd2FpdCBwcmltYXJ5U2VydmljZS5nZXRDaGFyYWN0ZXJpc3RpYyhjaGFyYWN0ZXJpc3RpYyk7XG4gICAgICAvLyBsaXN0ZW4gZm9yIGNoYXJhY3RlcmlzdGljIHZhbHVlIGNoYW5nZXNcbiAgICAgIGlmIChjaGFyLnByb3BlcnRpZXMubm90aWZ5KSB7XG4gICAgICAgIGNoYXIuc3RhcnROb3RpZmljYXRpb25zKCkudGhlbihfID0+IHtcbiAgICAgICAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBTdGFydGluZyBub3RpZmljYXRpb25zIG9mIFwiJXNcIicsIGNoYXJhY3RlcmlzdGljKTtcbiAgICAgICAgICBjaGFyLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYXJhY3RlcmlzdGljdmFsdWVjaGFuZ2VkJywgdGhpcy5vbkNoYXJhY3RlcmlzdGljQ2hhbmdlZC5iaW5kKHRoaXMpKTtcbiAgICAgICAgfSwgKGVycm9yOiBET01FeGNlcHRpb24pID0+IHtcbiAgICAgICAgICBQcm9taXNlLnJlamVjdChgJHtlcnJvci5tZXNzYWdlfSAoJHtjaGFyYWN0ZXJpc3RpY30pYCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIGNoYXIuYWRkRXZlbnRMaXN0ZW5lcignY2hhcmFjdGVyaXN0aWN2YWx1ZWNoYW5nZWQnLCB0aGlzLm9uQ2hhcmFjdGVyaXN0aWNDaGFuZ2VkLmJpbmQodGhpcykpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGNoYXI7XG4gICAgfVxuICAgIGNhdGNoIChyZWplY3Rpb25FcnJvcikge1xuICAgICAgUHJvbWlzZS5yZWplY3QoYCR7cmVqZWN0aW9uRXJyb3IubWVzc2FnZX0gKCR7Y2hhcmFjdGVyaXN0aWN9KWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXF1ZXN0cyBhIGNoYXJhY3RlcmlzdGljIGZyb20gdGhlIHByaW1hcnkgc2VydmljZS5cbiAgICpcbiAgICogQHBhcmFtIHByaW1hcnlTZXJ2aWNlIFRoZSBwcmltYXJ5IHNlcnZpY2UuXG4gICAqIEBwYXJhbSBjaGFyYWN0ZXJpc3RpYyBUaGUgY2hhcmFjdGVyaXN0aWMncyBVVUlELlxuICAgKiBAcmV0dXJucyBUaGUgY2hhcmFjdGVyaXN0aWMgZGVzY3JpcHRpb24gKGFzIGEgT2JzZXJ2YWJsZSkuXG4gICAqL1xuICBnZXRDaGFyYWN0ZXJpc3RpYyQoXG4gICAgcHJpbWFyeVNlcnZpY2U6IEJsdWV0b290aFJlbW90ZUdBVFRTZXJ2aWNlLFxuICAgIGNoYXJhY3RlcmlzdGljOiBCbHVldG9vdGhDaGFyYWN0ZXJpc3RpY1VVSURcbiAgKTogT2JzZXJ2YWJsZTx2b2lkIHwgQmx1ZXRvb3RoUmVtb3RlR0FUVENoYXJhY3RlcmlzdGljPiB7XG4gICAgdGhpcy5jb25zb2xlLmxvZygnW0JMRTo6SW5mb10gR2V0dGluZyBDaGFyYWN0ZXJpc3RpYyBcIiVzXCIgb2YgJW8nLCBjaGFyYWN0ZXJpc3RpYywgcHJpbWFyeVNlcnZpY2UpO1xuXG4gICAgcmV0dXJuIGZyb20odGhpcy5nZXRDaGFyYWN0ZXJpc3RpYyhwcmltYXJ5U2VydmljZSwgY2hhcmFjdGVyaXN0aWMpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBjaGFyYWN0ZXJpc3RpYydzIHN0YXRlLlxuICAgKlxuICAgKiBAcGFyYW0gc2VydmljZSBUaGUgcGFyZW50IHNlcnZpY2Ugb2YgdGhlIGNoYXJhY3RlcmlzdGljLlxuICAgKiBAcGFyYW0gY2hhcmFjdGVyaXN0aWMgVGhlIHJlcXVlc3RlZCBjaGFyYWN0ZXJpc3RpY1xuICAgKiBAcGFyYW0gc3RhdGUgQW4gQXJyYXlCdWZmZXIgY29udGFpbmluZyB0aGUgdmFsdWUgb2YgdGhlIGNoYXJhY3RlcmlzdGljLlxuICAgKiBAcmV0dXJuIFRoZSBwcmltYXJ5IHNlcnZpY2UgKHVzZWZ1bCBmb3IgY2hhaW5pbmcpLlxuICAgKi9cbiAgc2V0Q2hhcmFjdGVyaXN0aWNTdGF0ZShzZXJ2aWNlOiBCbHVldG9vdGhTZXJ2aWNlVVVJRCwgY2hhcmFjdGVyaXN0aWM6IEJsdWV0b290aENoYXJhY3RlcmlzdGljVVVJRCwgc3RhdGU6IEFycmF5QnVmZmVyKSB7XG4gICAgY29uc3QgcHJpbWFyeVNlcnZpY2UgPSB0aGlzLmdldFByaW1hcnlTZXJ2aWNlJCh0aGlzLmdhdHRTZXJ2ZXIsIHNlcnZpY2UpO1xuXG4gICAgcHJpbWFyeVNlcnZpY2VcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogdmFyaWFibGUtbmFtZVxuICAgICAgLnBpcGUobWVyZ2VNYXAoKF9wcmltYXJ5U2VydmljZTogQmx1ZXRvb3RoUmVtb3RlR0FUVFNlcnZpY2UpID0+IHRoaXMuZ2V0Q2hhcmFjdGVyaXN0aWMkKF9wcmltYXJ5U2VydmljZSwgY2hhcmFjdGVyaXN0aWMpKSlcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tc2hhZG93ZWQtdmFyaWFibGVcbiAgICAgIC5zdWJzY3JpYmUoKGNoYXJhY3RlcmlzdGljOiBCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWMpID0+IHRoaXMud3JpdGVWYWx1ZSQoY2hhcmFjdGVyaXN0aWMsIHN0YXRlKSk7XG5cbiAgICByZXR1cm4gcHJpbWFyeVNlcnZpY2U7XG4gIH1cblxuICAvKipcbiAgICogRW5hYmxlcyB0aGUgc3BlY2lmaWVkIGNoYXJhY3RlcmlzdGljIG9mIGEgZ2l2ZW4gc2VydmljZS5cbiAgICpcbiAgICogQHBhcmFtIHNlcnZpY2UgVGhlIHBhcmVudCBzZXJ2aWNlIG9mIHRoZSBjaGFyYWN0ZXJpc3RpYy5cbiAgICogQHBhcmFtIGNoYXJhY3RlcmlzdGljIFRoZSByZXF1ZXN0ZWQgY2hhcmFjdGVyaXN0aWNcbiAgICogQHJldHVybiBUaGUgcHJpbWFyeSBzZXJ2aWNlICh1c2VmdWwgZm9yIGNoYWluaW5nKS5cbiAgICovXG4gIGVuYWJsZUNoYXJhY3RlcmlzdGljKHNlcnZpY2U6IEJsdWV0b290aFNlcnZpY2VVVUlELCBjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoQ2hhcmFjdGVyaXN0aWNVVUlELCBzdGF0ZT86IGFueSkge1xuICAgIHN0YXRlID0gc3RhdGUgfHwgbmV3IFVpbnQ4QXJyYXkoWzFdKTtcbiAgICByZXR1cm4gdGhpcy5zZXRDaGFyYWN0ZXJpc3RpY1N0YXRlKHNlcnZpY2UsIGNoYXJhY3RlcmlzdGljLCBzdGF0ZSk7XG4gIH1cblxuICAvKipcbiAgICogRGlzYWJsZXMgdGhlIHNwZWNpZmllZCBjaGFyYWN0ZXJpc3RpYyBvZiBhIGdpdmVuIHNlcnZpY2UuXG4gICAqXG4gICAqIEBwYXJhbSBzZXJ2aWNlIFRoZSBwYXJlbnQgc2VydmljZSBvZiB0aGUgY2hhcmFjdGVyaXN0aWMuXG4gICAqIEBwYXJhbSBjaGFyYWN0ZXJpc3RpYyBUaGUgcmVxdWVzdGVkIGNoYXJhY3RlcmlzdGljLlxuICAgKiBAcmV0dXJuIFRoZSBwcmltYXJ5IHNlcnZpY2UgKHVzZWZ1bCBmb3IgY2hhaW5pbmcpLlxuICAgKi9cbiAgZGlzYmFsZUNoYXJhY3RlcmlzdGljKHNlcnZpY2U6IEJsdWV0b290aFNlcnZpY2VVVUlELCBjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoQ2hhcmFjdGVyaXN0aWNVVUlELCBzdGF0ZT86IGFueSkge1xuICAgIHN0YXRlID0gc3RhdGUgfHwgbmV3IFVpbnQ4QXJyYXkoWzBdKTtcbiAgICByZXR1cm4gdGhpcy5zZXRDaGFyYWN0ZXJpc3RpY1N0YXRlKHNlcnZpY2UsIGNoYXJhY3RlcmlzdGljLCBzdGF0ZSk7XG4gIH1cblxuICAvKipcbiAgICogRGlzcGF0Y2hlcyBuZXcgdmFsdWVzIGVtaXR0ZWQgYnkgYSBjaGFyYWN0ZXJpc3RpYy5cbiAgICpcbiAgICogQHBhcmFtIGV2ZW50IHRoZSBkaXN0cGF0Y2hlZCBldmVudC5cbiAgICovXG4gIG9uQ2hhcmFjdGVyaXN0aWNDaGFuZ2VkKGV2ZW50OiBFdmVudCkge1xuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIERpc3BhdGNoaW5nIG5ldyBjaGFyYWN0ZXJpc3RpYyB2YWx1ZSAlbycsIGV2ZW50KTtcblxuICAgIGNvbnN0IHZhbHVlID0gKGV2ZW50LnRhcmdldCBhcyBCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWMpLnZhbHVlO1xuICAgIHRoaXMuY2hhcmFjdGVyaXN0aWNWYWx1ZUNoYW5nZXMkLmVtaXQodmFsdWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlYWRzIGEgdmFsdWUgZnJvbSB0aGUgY2hhcmFjdGVyaXN0aWNzLCBhcyBhIERhdGFWaWV3LlxuICAgKlxuICAgKiBAcGFyYW0gY2hhcmFjdGVyaXN0aWMgVGhlIHJlcXVlc3RlZCBjaGFyYWN0ZXJpc3RpYy5cbiAgICogQHJldHVybiB0aGUgRGF0YVZpZXcgdmFsdWUgKGFzIGFuIE9ic2VydmFibGUpLlxuICAgKi9cbiAgcmVhZFZhbHVlJChjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoUmVtb3RlR0FUVENoYXJhY3RlcmlzdGljKTogT2JzZXJ2YWJsZTxEYXRhVmlldz4ge1xuICAgIHRoaXMuY29uc29sZS5sb2coJ1tCTEU6OkluZm9dIFJlYWRpbmcgQ2hhcmFjdGVyaXN0aWMgJW8nLCBjaGFyYWN0ZXJpc3RpYyk7XG5cbiAgICByZXR1cm4gZnJvbShcbiAgICAgIGNoYXJhY3RlcmlzdGljXG4gICAgICAgIC5yZWFkVmFsdWUoKVxuICAgICAgICAudGhlbigoZGF0YTogRGF0YVZpZXcpID0+IFByb21pc2UucmVzb2x2ZShkYXRhKSwgKGVycm9yOiBET01FeGNlcHRpb24pID0+IFByb21pc2UucmVqZWN0KGAke2Vycm9yLm1lc3NhZ2V9YCkpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXcml0ZXMgYSB2YWx1ZSBpbnRvIHRoZSBzcGVjaWZpZWQgY2hhcmFjdGVyaXN0aWMuXG4gICAqXG4gICAqIEBwYXJhbSBjaGFyYWN0ZXJpc3RpYyBUaGUgcmVxdWVzdGVkIGNoYXJhY3RlcmlzdGljLlxuICAgKiBAcGFyYW0gdmFsdWUgVGhlIHZhbHVlIHRvIGJlIHdyaXR0ZW4gKGFzIGFuIEFycmF5QnVmZmVyIG9yIFVpbnQ4QXJyYXkpLlxuICAgKiBAcmV0dXJuIGFuIHZvaWQgT2JzZXJ2YWJsZS5cbiAgICovXG4gIHdyaXRlVmFsdWUkKGNoYXJhY3RlcmlzdGljOiBCbHVldG9vdGhSZW1vdGVHQVRUQ2hhcmFjdGVyaXN0aWMsIHZhbHVlOiBBcnJheUJ1ZmZlciB8IFVpbnQ4QXJyYXkpIHtcbiAgICB0aGlzLmNvbnNvbGUubG9nKCdbQkxFOjpJbmZvXSBXcml0aW5nIENoYXJhY3RlcmlzdGljICVvJywgY2hhcmFjdGVyaXN0aWMpO1xuXG4gICAgcmV0dXJuIGZyb20oY2hhcmFjdGVyaXN0aWMud3JpdGVWYWx1ZSh2YWx1ZSkudGhlbihfID0+IFByb21pc2UucmVzb2x2ZSgpLCAoZXJyb3I6IERPTUV4Y2VwdGlvbikgPT4gUHJvbWlzZS5yZWplY3QoYCR7ZXJyb3IubWVzc2FnZX1gKSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgc3RyZWFtIG9mIERhdGFWaWV3IHZhbHVlcyBlbWl0dGVkIGJ5IHRoZSBzcGVjaWZpZWQgY2hhcmFjdGVyaXN0aWMuXG4gICAqXG4gICAqIEBwYXJhbSBjaGFyYWN0ZXJpc3RpYyBUaGUgY2hhcmFjdGVyaXN0aWMgd2hpY2ggdmFsdWUgeW91IHdhbnQgdG8gb2JzZXJ2ZVxuICAgKiBAcmV0dXJuIFRoZSBzdHJlYW0gb2YgRGF0YVZpZXcgdmFsdWVzLlxuICAgKi9cbiAgb2JzZXJ2ZVZhbHVlJChjaGFyYWN0ZXJpc3RpYzogQmx1ZXRvb3RoUmVtb3RlR0FUVENoYXJhY3RlcmlzdGljKTogT2JzZXJ2YWJsZTxEYXRhVmlldz4ge1xuICAgIGNoYXJhY3RlcmlzdGljLnN0YXJ0Tm90aWZpY2F0aW9ucygpO1xuICAgIGNvbnN0IGRpc2Nvbm5lY3RlZCA9IGZyb21FdmVudChjaGFyYWN0ZXJpc3RpYy5zZXJ2aWNlLmRldmljZSwgJ2dhdHRzZXJ2ZXJkaXNjb25uZWN0ZWQnKTtcbiAgICByZXR1cm4gZnJvbUV2ZW50KGNoYXJhY3RlcmlzdGljLCAnY2hhcmFjdGVyaXN0aWN2YWx1ZWNoYW5nZWQnKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoZXZlbnQ6IEV2ZW50KSA9PiAoZXZlbnQudGFyZ2V0IGFzIEJsdWV0b290aFJlbW90ZUdBVFRDaGFyYWN0ZXJpc3RpYykudmFsdWUgYXMgRGF0YVZpZXcpLFxuICAgICAgICB0YWtlVW50aWwoZGlzY29ubmVjdGVkKVxuICAgICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHV0aWxpdHkgbWV0aG9kIHRvIGNvbnZlcnQgTEUgdG8gYW4gdW5zaWduZWQgMTYtYml0IGludGVnZXIgdmFsdWVzLlxuICAgKlxuICAgKiBAcGFyYW0gZGF0YSBUaGUgRGF0YVZpZXcgYmluYXJ5IGRhdGEuXG4gICAqIEBwYXJhbSBieXRlT2Zmc2V0IFRoZSBvZmZzZXQsIGluIGJ5dGUsIGZyb20gdGhlIHN0YXJ0IG9mIHRoZSB2aWV3IHdoZXJlIHRvIHJlYWQgdGhlIGRhdGEuXG4gICAqIEByZXR1cm4gQW4gdW5zaWduZWQgMTYtYml0IGludGVnZXIgbnVtYmVyLlxuICAgKi9cbiAgbGl0dGxlRW5kaWFuVG9VaW50MTYoZGF0YTogYW55LCBieXRlT2Zmc2V0OiBudW1iZXIpOiBudW1iZXIge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1iaXR3aXNlXG4gICAgcmV0dXJuICh0aGlzLmxpdHRsZUVuZGlhblRvVWludDgoZGF0YSwgYnl0ZU9mZnNldCArIDEpIDw8IDgpICsgdGhpcy5saXR0bGVFbmRpYW5Ub1VpbnQ4KGRhdGEsIGJ5dGVPZmZzZXQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgdXRpbGl0eSBtZXRob2QgdG8gY29udmVydCBMRSB0byBhbiB1bnNpZ25lZCA4LWJpdCBpbnRlZ2VyIHZhbHVlcy5cbiAgICpcbiAgICogQHBhcmFtIGRhdGEgVGhlIERhdGFWaWV3IGJpbmFyeSBkYXRhLlxuICAgKiBAcGFyYW0gYnl0ZU9mZnNldCBUaGUgb2Zmc2V0LCBpbiBieXRlLCBmcm9tIHRoZSBzdGFydCBvZiB0aGUgdmlldyB3aGVyZSB0byByZWFkIHRoZSBkYXRhLlxuICAgKiBAcmV0dXJuIEFuIHVuc2lnbmVkIDgtYml0IGludGVnZXIgbnVtYmVyLlxuICAgKi9cbiAgbGl0dGxlRW5kaWFuVG9VaW50OChkYXRhOiBhbnksIGJ5dGVPZmZzZXQ6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIGRhdGEuZ2V0VWludDgoYnl0ZU9mZnNldCk7XG4gIH1cblxuICAvKipcbiAgICogU2VuZHMgcmFuZG9tIGRhdGEgKGZvciB0ZXN0aW5nIHB1cnBvc2VzIG9ubHkpLlxuICAgKlxuICAgKiBAcmV0dXJuIFJhbmRvbSB1bnNpZ25lZCA4LWJpdCBpbnRlZ2VyIHZhbHVlcy5cbiAgICovXG4gIGZha2VOZXh0KGZha2VWYWx1ZT86ICgpID0+IERhdGFWaWV3KSB7XG4gICAgaWYgKGZha2VWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBmYWtlVmFsdWUgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGR2ID0gbmV3IERhdGFWaWV3KG5ldyBBcnJheUJ1ZmZlcig4KSk7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1iaXR3aXNlXG4gICAgICAgIGR2LnNldFVpbnQ4KDAsIChNYXRoLnJhbmRvbSgpICogMTEwKSB8IDApO1xuICAgICAgICByZXR1cm4gZHY7XG4gICAgICB9O1xuICAgIH1cblxuICAgIHRoaXMuY2hhcmFjdGVyaXN0aWNWYWx1ZUNoYW5nZXMkLmVtaXQoZmFrZVZhbHVlKCkpO1xuICB9XG59XG4iXX0=